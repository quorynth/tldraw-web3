"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[865],{2125:function(e,t,i){i.d(t,{M:function(){return tb}});var s,r,n,a,h,o,l,p,g,d,u,c,S,f,m,y,I,P,C,w,_,B,T,b,v,k,F,A,M,O,E,U,R,L,K,z,V,D,H,Z,G,N,Y,X,q,j,Q,W,$,J,ee,et,ei,es,er,en,ea,eh,eo,el,ep,eg,ed,eu,ec,eS,ef,em,ey,eI,eP,eC,ew,e_,ex,eB=i(5462),eT=i(439),eb=i(4899),ev=i(9824),ek=i(6729),eF=i(5228),eA=i(5824),eM=i(7702),eO=i(9749),eE=i(6694),eU=i(663),eR=i(5335),eL=i(8114),eK=i(9699),ez=i(7344),eV=i(1764),eD=i(3729),eH=i(5771),eZ=i(681),eG=i(162),eN=i(7251),eY=i(3882),eX=i(1981),eq=i(4264),ej=i(8457),eQ=i(9046),eW=i(649),e$=i(7671),eJ=i(3795),e0=i(5483),e1=i(8745),e2=i(5631),e5=i(8484),e4=i(9017),e8=i(9511),e7=i(7716),e3=i(4970),e6=i(4335),e9=i(1601),te=i(3545),tt=i(2958),ti=i(7278),ts=i(3451),tr=i(1686),tn=i(3718),ta=i(8172),th=i(8811),to=Object.create,tl=Object.defineProperty,tp=Object.getOwnPropertyDescriptor,tg=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),td=e=>{throw TypeError(e)},tu=(e,t,i)=>t in e?tl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,tc=(e,t)=>tl(e,"name",{value:t,configurable:!0}),tS=["class","method","getter","setter","accessor","field","value","get","set"],tf=e=>void 0!==e&&"function"!=typeof e?td("Function expected"):e,tm=(e,t,i,s,r)=>({kind:tS[e],name:t,metadata:s,addInitializer:e=>i._?td("Already initialized"):r.push(tf(e||null))}),ty=(e,t)=>tu(t,tg("metadata"),e[3]),tI=(e,t,i,s)=>{for(var r=0,n=e[t>>1],a=n&&n.length;r<a;r++)1&t?n[r].call(i):s=n[r].call(i,s);return s},tP=(e,t,i,s,r,n)=>{var a,h,o,l,p,g=7&t,d=!!(8&t),u=!!(16&t),c=g>3?e.length+1:g?d?1:2:0,S=tS[g+5],f=g>3&&(e[c-1]=[]),m=e[c]||(e[c]=[]),y=g&&(u||d||(r=r.prototype),g<5&&(g>3||!u)&&tp(g<4?r:{get[i](){return tx(this,n)},set[i](x){return tB(this,n,x)}},i));g?u&&g<4&&tc(n,(g>2?"set ":g>1?"get ":"")+i):tc(r,i);for(var I=s.length-1;I>=0;I--)l=tm(g,i,o={},e[3],m),g&&(l.static=d,l.private=u,p=l.access={has:u?e=>t_(r,e):e=>i in e},3^g&&(p.get=u?e=>(1^g?tx:tT)(e,r,4^g?n:y.get):e=>e[i]),g>2&&(p.set=u?(e,t)=>tB(e,r,t,4^g?n:y.set):(e,t)=>e[i]=t)),h=(0,s[I])(g?g<4?u?n:y[S]:g>4?void 0:{get:y.get,set:y.set}:r,l),o._=1,4^g||void 0===h?tf(h)&&(g>4?f.unshift(h):g?u?n=h:y[S]=h:r=h):"object"!=typeof h||null===h?td("Object expected"):(tf(a=h.get)&&(y.get=a),tf(a=h.set)&&(y.set=a),tf(a=h.init)&&f.unshift(a));return g||ty(e,r),y&&tl(r,i,y),u?4^g?n:y:r},tC=(e,t,i)=>tu(e,"symbol"!=typeof t?t+"":t,i),tw=(e,t,i)=>t.has(e)||td("Cannot "+i),t_=(e,t)=>Object(t)!==t?td('Cannot use the "in" operator on this value'):e.has(t),tx=(e,t,i)=>(tw(e,t,"read from private field"),i?i.call(e):t.get(e)),tB=(e,t,i,s)=>(tw(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),tT=(e,t,i)=>(tw(e,t,"access private method"),i);class tb extends(e_=ek,ew=[eB.Fl],eC=[eB.Fl],eP=[eB.Fl],eI=[eB.Fl],ey=[eB.Fl],em=[eB.Fl],ef=[eB.Fl],eS=[eB.Fl],ec=[eB.Fl],eu=[eB.Fl],ed=[eB.Fl],eg=[eB.Fl],ep=[eB.Fl],el=[eB.Fl],eo=[eB.Fl],eh=[eB.Fl],ea=[eB.Fl],en=[eB.Fl],er=[eB.Fl],es=[eB.Fl],ei=[eB.Fl],et=[eB.Fl],ee=[eB.Fl],J=[eB.Fl],$=[eB.Fl],W=[eB.Fl],Q=[eB.Fl],j=[eB.Fl],q=[eB.Fl],X=[eB.Fl],Y=[eB.Fl],N=[eB.Fl],G=[eB.Fl],Z=[eB.Fl],H=[eB.Fl],D=[eB.Fl],V=[eB.Fl],z=[eB.Fl],K=[eB.Fl],L=[eB.Fl],R=[eB.Fl],U=[eB.Fl],E=[eB.Fl],O=[eB.Fl],M=[eB.Fl],A=[eB.Fl],F=[eB.Fl],k=[eB.Fl],v=[eB.Fl],b=[eB.Fl],T=[eB.Fl],B=[eB.Fl],_=[eB.Fl],w=[eB.Fl],C=[eB.Fl],P=[eB.Fl],I=[eB.Fl],y=[eB.Fl],m=[eB.Fl],f=[eB.Fl],S=[eB.Fl],c=[eB.Fl],u=[eB.Fl],d=[eB.Fl],g=[eB.Fl],p=[(0,eB.Fl)({isEqual:(e,t)=>e.equals(t)})],l=[eB.Fl],o=[eB.Fl],h=[eB.Fl],a=[ev.ak],n=[ev.ak],r=[ev.ak],s=[ev.ak],e_){constructor({store:e,user:t,shapeUtils:i,bindingUtils:s,tools:r,getContainer:n,cameraOptions:a,textOptions:h,initialState:o,autoFocus:l,inferDarkMode:p,options:g,isShapeHidden:d,getShapeVisibility:u,fontAssetUrls:c}){super(),tI(ex,5,this),tC(this,"id",(0,ev.EL)()),tC(this,"_getShapeVisibility"),tC(this,"options"),tC(this,"contextId",(0,ev.EL)()),tC(this,"store"),tC(this,"root"),tC(this,"disposables",new Set),tC(this,"isDisposed",!1),tC(this,"_tickManager"),tC(this,"snaps"),tC(this,"timers",ez.r.forContext(this.contextId)),tC(this,"user"),tC(this,"textMeasure"),tC(this,"fonts"),tC(this,"environment",eL.a),tC(this,"scribbles"),tC(this,"sideEffects"),tC(this,"edgeScrollManager"),tC(this,"focusManager"),tC(this,"getContainer"),tC(this,"shapeUtils"),tC(this,"styleProps"),tC(this,"bindingUtils"),tC(this,"history"),tC(this,"_shouldIgnoreShapeLock",!1),tC(this,"_crashingError",null),tC(this,"_isChangingStyleTimeout",-1),tC(this,"menus",eK.h.forContext(this.contextId)),tC(this,"_currentRichTextEditor",(0,eB.cn)("rich text editor",null)),tC(this,"_textOptions"),tC(this,"_cameraOptions",(0,eB.cn)("camera options",eE.B8)),tC(this,"_viewportAnimation",null),tC(this,"_willSetInitialBounds",!0),tC(this,"_isLockedOnFollowingUser",(0,eB.cn)("isLockedOnFollowingUser",!1)),tC(this,"_cameraState",(0,eB.cn)("camera state","idle")),tC(this,"_cameraStateTimeoutRemaining",0),tC(this,"_currentPageShapeIds"),tC(this,"_shapeGeometryCaches",{}),tC(this,"_notVisibleShapes",(0,e4.A)(this)),tC(this,"_parentIdsToChildIds"),tC(this,"animatingShapes",new Map),tC(this,"externalAssetContentHandlers",{file:null,url:null}),tC(this,"temporaryAssetPreview",new Map),tC(this,"externalContentHandlers",{text:null,files:null,"file-replace":null,embed:null,"svg-text":null,url:null,tldraw:null,excalidraw:null}),tC(this,"inputs",{originPagePoint:new eZ.B,originScreenPoint:new eZ.B,previousPagePoint:new eZ.B,previousScreenPoint:new eZ.B,currentPagePoint:new eZ.B,currentScreenPoint:new eZ.B,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,isSpacebarPanning:!1,pointerVelocity:new eZ.B}),tC(this,"_clickManager",new e3.o(this)),tC(this,"_prevCursor","default"),tC(this,"_shiftKeyTimeout",-1),tC(this,"_altKeyTimeout",-1),tC(this,"_ctrlKeyTimeout",-1),tC(this,"_metaKeyTimeout",-1),tC(this,"_restoreToolId","select"),tC(this,"_pinchStart",1),tC(this,"_didPinch",!1),tC(this,"_selectedShapeIdsAtPointerDown",[]),tC(this,"_longPressTimeout",-1),tC(this,"capturedPointerId",null),tC(this,"performanceTracker"),tC(this,"performanceTrackerTimeout",-1),tC(this,"_pendingEventsForNextTick",[]),(0,ev.hu)(!(d&&u),"Cannot use both isShapeHidden and getShapeVisibility"),this._getShapeVisibility=d?(e,t)=>d(e,t)?"hidden":"inherit":u,this.options={...eV.a,...g},this.store=e,this.history=new tt.E({store:e,annotateError:e=>{this.annotateError(e,{origin:"history.batch",willCrashApp:!0}),this.crash(e)}}),this.snaps=new ts.f(this),this.disposables.add(this.timers.dispose),this._cameraOptions.set({...eE.B8,...a}),this._textOptions=(0,eB.cn)("text options",h??null),this.user=new ta.K(t??(0,eA.L)(),p??!1),this.disposables.add(()=>this.user.dispose()),this.getContainer=n,this.textMeasure=new tr.R(this),this.disposables.add(()=>this.textMeasure.dispose()),this.fonts=new te.Q(this,c),this._tickManager=new tn.r(this);class S extends th.m{static initial=o??""}this.root=new S(this),this.root.children={};let f=(0,eO.m)(i),m={},y={},I=new Map;for(let e of f){let t=new e(this);m[e.type]=t;let i=(0,eb.DR)(e.props??{});for(let t of(y[e.type]=i,i.keys()))if(I.has(t.id)){if(I.get(t.id)!==t)throw Error(`Multiple style props with id "${t.id}" in use. Style prop IDs must be unique.`)}else I.set(t.id,t)}this.shapeUtils=m,this.styleProps=y;let P=(0,eM.c)(s),C={};for(let e of P){let t=new e(this);C[e.type]=t}for(let e of(this.bindingUtils=C,[...r])){if((0,ev.nr)(this.root.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);this.root.children[e.id]=new e(this,this.root)}this.scribbles=new ti.o(this);let w=(e,t)=>{let i=null,s=e.selectedShapeIds.filter(e=>!t.has(e));s.length!==e.selectedShapeIds.length&&(i||(i={...e}),i.selectedShapeIds=s);let r=e.erasingShapeIds.filter(e=>!t.has(e));r.length!==e.erasingShapeIds.length&&(i||(i={...e}),i.erasingShapeIds=r),e.hoveredShapeId&&t.has(e.hoveredShapeId)&&(i||(i={...e}),i.hoveredShapeId=null),e.editingShapeId&&t.has(e.editingShapeId)&&(i||(i={...e}),i.editingShapeId=null);let n=e.hintingShapeIds.filter(e=>!t.has(e));return n.length!==e.hintingShapeIds.length&&(i||(i={...e}),i.hintingShapeIds=n),e.focusedGroupId&&t.has(e.focusedGroupId)&&(i||(i={...e}),i.focusedGroupId=null),i};this.sideEffects=this.store.sideEffects;let _=new Map,B=new Set,T=new Set,b=new Set;if(this.disposables.add(this.sideEffects.registerOperationCompleteHandler(()=>{for(let e of(B.clear(),T)){T.delete(e);let t=this.getShape(e);if(!t)continue;let i=this.getShapeUtil(t),s=i.onChildrenChange?.(t);s?.length&&this.updateShapes(s)}if(b.size){let e=b;for(let t of(b=new Set,e)){let e=this.getBindingUtil(t);e.onOperationComplete?.()}}if(_.size){let e=_;for(let t of(_=new Map,e.values()))this.getBindingUtil(t.binding).onAfterDelete?.(t)}this.emit("update")})),this.disposables.add(this.sideEffects.register({shape:{afterChange:(e,t)=>{for(let i of this.getBindingsInvolvingShape(t))b.add(i.type),i.fromId===t.id&&this.getBindingUtil(i).onAfterChangeFromShape?.({binding:i,shapeBefore:e,shapeAfter:t,reason:"self"}),i.toId===t.id&&this.getBindingUtil(i).onAfterChangeToShape?.({binding:i,shapeBefore:e,shapeAfter:t,reason:"self"});if(e.parentId!==t.parentId){let e=e=>{let t=this.getShape(e);if(t)for(let e of this.getBindingsInvolvingShape(t))b.add(e.type),e.fromId===t.id&&this.getBindingUtil(e).onAfterChangeFromShape?.({binding:e,shapeBefore:t,shapeAfter:t,reason:"ancestry"}),e.toId===t.id&&this.getBindingUtil(e).onAfterChangeToShape?.({binding:e,shapeBefore:t,shapeAfter:t,reason:"ancestry"})};e(t.id),this.visitDescendants(t.id,e)}if(e.parentId!==t.parentId&&(0,eb.r5)(t.parentId)){let i=new Set([e.id]);for(let s of(this.visitDescendants(e.id,e=>{i.add(e)}),this.getPageStates())){if(s.pageId===t.parentId)continue;let e=w(s,i);e&&this.store.put([e])}}e.parentId&&(0,eb.YT)(e.parentId)&&T.add(e.parentId),t.parentId!==e.parentId&&(0,eb.YT)(t.parentId)&&T.add(t.parentId)},beforeDelete:e=>{if(B.has(e.id))return;e.parentId&&(0,eb.YT)(e.parentId)&&T.add(e.parentId),B.add(e.id);let t=[];for(let i of this.getBindingsInvolvingShape(e)){b.add(i.type),t.push(i.id);let s=this.getBindingUtil(i);i.fromId===e.id?(s.onBeforeIsolateToShape?.({binding:i,removedShape:e}),s.onBeforeDeleteFromShape?.({binding:i,shape:e})):(s.onBeforeIsolateFromShape?.({binding:i,removedShape:e}),s.onBeforeDeleteToShape?.({binding:i,shape:e}))}t.length&&this.deleteBindings(t);let i=new Set([e.id]),s=(0,ev.oA)(this.getPageStates().map(e=>w(e,i)));s.length&&this.store.put(s)}},binding:{beforeCreate:e=>this.getBindingUtil(e).onBeforeCreate?.({binding:e})||e,afterCreate:e=>{b.add(e.type),this.getBindingUtil(e).onAfterCreate?.({binding:e})},beforeChange:(e,t)=>this.getBindingUtil(t).onBeforeChange?.({bindingBefore:e,bindingAfter:t})||t,afterChange:(e,t)=>{b.add(t.type),this.getBindingUtil(t).onAfterChange?.({bindingBefore:e,bindingAfter:t})},beforeDelete:e=>{this.getBindingUtil(e).onBeforeDelete?.({binding:e})},afterDelete:e=>{this.getBindingUtil(e).onAfterDelete?.({binding:e}),b.add(e.type)}},page:{afterCreate:e=>{let t=eb.AN.createId(e.id),i=eb.iS.createId(e.id);this.store.has(t)||this.store.put([eb.AN.create({id:t})]),this.store.has(i)||this.store.put([eb.iS.create({id:i,pageId:e.id})])},afterDelete:(e,t)=>{if(this.getInstanceState()?.currentPageId===e.id){let i=this.getPages().find(t=>t.id!==e.id)?.id;i?this.store.put([{...this.getInstanceState(),currentPageId:i}]):"user"===t&&this.store.ensureStoreIsUsable()}let i=eb.AN.createId(e.id),s=eb.iS.createId(e.id);this.store.remove([i,s])}},instance:{afterChange:(e,t,i)=>{if(!this.store.has(t.currentPageId)){let s=this.store.has(e.currentPageId)?e.currentPageId:this.getPages()[0]?.id;s?this.store.update(t.id,e=>({...e,currentPageId:s})):"user"===i&&this.store.ensureStoreIsUsable()}}},instance_page_state:{afterChange:(e,t)=>{if(e?.selectedShapeIds!==t?.selectedShapeIds){let e=t.selectedShapeIds.filter(e=>{let i=this.getShape(e)?.parentId;for(;(0,eb.YT)(i);){if(t.selectedShapeIds.includes(i))return!1;i=this.getShape(i)?.parentId}return!0}),i=null;if(e.length>0){let t=this.findCommonAncestor((0,ev.oA)(e.map(e=>this.getShape(e))),e=>this.isShapeOfType(e,"group"));t&&(i=t)}else t?.focusedGroupId&&(i=t.focusedGroupId);(e.length!==t.selectedShapeIds.length||i!==t.focusedGroupId)&&this.store.put([{...t,selectedShapeIds:e,focusedGroupId:i??null}])}}}})),this._currentPageShapeIds=(0,e7.Q)(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=(0,e8.s)(this.store),this.disposables.add(this.store.listen(e=>{this.emit("change",e)})),this.disposables.add(this.history.dispose),this.run(()=>{this.store.ensureStoreIsUsable(),this._updateCurrentPageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]})},{history:"ignore"}),o&&void 0===this.root.children[o])throw Error(`No state found for initialState "${o}".`);if(this.root.enter(void 0,"initial"),this.edgeScrollManager=new e6.O(this),this.focusManager=new e9.I(this,l),this.disposables.add(this.focusManager.dispose.bind(this.focusManager)),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.on("tick",this._flushEventsForTick),this.timers.requestAnimationFrame(()=>{this._tickManager.start()}),this.performanceTracker=new ev.aF,this.store.props.collaboration?.mode){let e=this.store.props.collaboration.mode;this.disposables.add((0,eB.Ym)("update collaboration mode",()=>{this.store.put([{...this.getInstanceState(),isReadonly:"readonly"===e.get()}])}))}}getIsShapeHiddenCache(){return this._getShapeVisibility?this.store.createComputedCache("isShapeHidden",e=>{let t=this._getShapeVisibility(e,this);return!eb.ez.isId(e.parentId)&&this.isShapeHidden(e.parentId)?"visible"!==t:"hidden"===t}):null}isShapeHidden(e){return!!this._getShapeVisibility&&!!this.getIsShapeHiddenCache().get("string"==typeof e?e:e.id)}dispose(){this.disposables.forEach(e=>e()),this.disposables.clear(),this.store.dispose(),this.isDisposed=!0}getShapeUtil(e){let t="string"==typeof e?e:e.type,i=(0,ev.eg)(this.shapeUtils,t);return(0,ev.hu)(i,`No shape util found for type "${t}"`),i}hasShapeUtil(e){let t="string"==typeof e?e:e.type;return(0,ev.nr)(this.shapeUtils,t)}getBindingUtil(e){let t="string"==typeof e?e:e.type,i=(0,ev.eg)(this.bindingUtils,t);return(0,ev.hu)(i,`No binding util found for type "${t}"`),i}undo(){return this._flushEventsForTick(0),this.complete(),this.history.undo(),this}getCanUndo(){return this.history.getNumUndos()>0}redo(){return this._flushEventsForTick(0),this.complete(),this.history.redo(),this}clearHistory(){return this.history.clear(),this}getCanRedo(){return this.history.getNumRedos()>0}mark(e){return"string"==typeof e?console.warn(`[tldraw] \`editor.history.mark("${e}")\` is deprecated. Please use \`const myMarkId = editor.markHistoryStoppingPoint()\` instead.`):console.warn("[tldraw] `editor.mark()` is deprecated. Use `editor.markHistoryStoppingPoint()` instead."),this.history._mark(e??(0,ev.EL)()),this}markHistoryStoppingPoint(e){let t=`[${e??"stop"}]_${(0,ev.EL)()}`;return this.history._mark(t),t}getMarkIdMatching(e){return this.history.getMarkIdMatching(e)}squashToMark(e){return this.history.squashToMark(e),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}run(e,t){let i=this._shouldIgnoreShapeLock;this._shouldIgnoreShapeLock=t?.ignoreShapeLock??i;try{this.history.batch(e,t)}finally{this._shouldIgnoreShapeLock=i}return this}batch(e,t){return this.run(e,t)}annotateError(e,{origin:t,willCrashApp:i,tags:s,extras:r}){let n=this.createErrorAnnotations(t,i);return(0,ev.lw)(e,{tags:{...n.tags,...s},extras:{...n.extras,...r}}),i&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,t){try{let i=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:t},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes().map(e=>{let{props:t,...i}=e,{text:s,richText:r,...n}=t;return{...i,props:n}}),selectionCount:this.getSelectedShapes().length,editingShape:i?this.getShape(i):void 0,inputs:this.inputs,pageState:this.getCurrentPageState(),instanceState:this.getInstanceState(),collaboratorCount:this.getCollaboratorsOnCurrentPage().length}}}catch{return{tags:{origin:e,willCrashApp:t},extras:{}}}}getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)return!0;let s=i.getCurrent();if(s?.id===e){if(0===t.length)return!0;i=s;continue}break}return!1}isInAny(...e){return e.some(e=>this.isIn(e))}setCurrentTool(e,t={}){return this.root.transition(e,t),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){let e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)break;let s=i.children?.[e];if(!s)return;i=s}return i}getDocumentSettings(){return this.store.get(eb.G4)}updateDocumentSettings(e){return this.run(()=>{this.store.put([{...this.getDocumentSettings(),...e}])},{history:"ignore"}),this}getInstanceState(){return this.store.get(eb.PQ)}updateInstanceState(e,t){return this._updateInstanceState(e,{history:"ignore",...t}),void 0!==e.isChangingStyle&&(clearTimeout(this._isChangingStyleTimeout),!0===e.isChangingStyle&&(this._isChangingStyleTimeout=this.timers.setTimeout(()=>{this._updateInstanceState({isChangingStyle:!1},{history:"ignore"})},1e3))),this}_updateInstanceState(e,t){this.run(()=>{this.store.put([{...this.getInstanceState(),...e}])},t)}getOpenMenus(){return this.menus.getOpenMenus()}addOpenMenu(e){return this.menus.addOpenMenu(e),this}deleteOpenMenu(e){return this.menus.deleteOpenMenu(e),this}clearOpenMenus(){return this.menus.clearOpenMenus(),this}getIsMenuOpen(){return this.menus.hasAnyOpenMenus()}setCursor(e){return this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}}),this}getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return eb.iS.createId(this.getCurrentPageId())}updateCurrentPageState(e){return this._updateCurrentPageState(e),this}_updateCurrentPageState(e){this.store.update(e.id??this.getCurrentPageState().id,t=>({...t,...e}))}getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){return(0,ev.oA)(this.getSelectedShapeIds().map(e=>this.store.get(e)))}setSelectedShapes(e){return this.run(()=>{let t=e.map(e=>"string"==typeof e?e:e.id),{selectedShapeIds:i}=this.getCurrentPageState(),s=new Set(i);if(t.length===s.size&&t.every(e=>s.has(e)))return null;this.store.put([{...this.getCurrentPageState(),selectedShapeIds:t}])},{history:"record-preserveRedoStack"})}isAncestorSelected(e){let t="string"==typeof e?e:e?.id??null,i=this.getShape(t);if(!i)return!1;let s=this.getSelectedShapeIds();return!!this.findShapeAncestor(i,e=>s.includes(e.id))}select(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.setSelectedShapes(t),this}deselect(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this.getSelectedShapeIds();return i.length>0&&t.length>0&&this.setSelectedShapes(i.filter(e=>!t.includes(e))),this}selectAll(){let e=null,t=this.getSelectedShapeIds();if(t.length>0)for(let i of t){let t=this.getShape(i);if(t){if(null===e)e=t.parentId;else if(e!==t.parentId)return this}}e||(e=this.getCurrentPageId());let i=this.getSortedChildIdsForParent(e);return i.length<=0||this.setSelectedShapes(this._getUnlockedShapeIds(i)),this}selectAdjacentShape(e){let t;let i=this.getSelectedShapeIds(),s=i[0]?this.getShape(i[0])?.parentId:null,r=s&&i.every(e=>this.getShape(e)?.parentId===s)&&!(0,eb.r5)(s),n=r?this.getCurrentPageShapes().filter(e=>e.parentId===s):this.getCurrentPageShapes().filter(e=>(0,eb.r5)(e.parentId)),a=r?this._getShapesInReadingOrder(n):this.getCurrentPageShapesInReadingOrder(),h=1===i.length?i[0]:a.find(e=>i.includes(e.id))?.id;if("next"===e||"prev"===e){let i=a.map(e=>e.id),s=((h?i.indexOf(h):-1)+("next"===e?1:-1)+i.length)%i.length;t=i[s]}else{if(!h)return;t=this.getNearestAdjacentShape(n,h,e)}let o=this.getShape(t);o&&this._selectShapesAndZoom([o.id])}getCurrentPageShapesInReadingOrder(){let e=this.getCurrentPageShapes().filter(e=>(0,eb.r5)(e.parentId));return this._getShapesInReadingOrder(e)}_getShapesInReadingOrder(e){let t=e.filter(e=>this.getShapeUtil(e).canTabTo(e));if(t.length<=1)return t;let i=t.map(e=>({shape:e,center:this.getShapePageBounds(e).center}));i.sort((e,t)=>e.center.y-t.center.y);let s=[];for(let e of i){let t=-1;for(let i=s.length-1;i>=0;i--){let r=s[i],n=r[r.length-1];if(100>Math.abs(e.center.y-n.center.y)){t=i;break}}-1===t?s.push([e]):s[t].push(e)}for(let e of s)e.sort((e,t)=>e.center.x-t.center.x);for(let e of s)if(!(e.length<=2))for(let t=0;t<e.length-2;t++){let i=e[t],s=e[t+1],r=e[t+2],n=eZ.B.Dist2(i.center,s.center);eZ.B.Dist2(i.center,r.center)<.9*n&&20>=Math.abs(eZ.B.Angle(i.center,r.center)*(180/Math.PI))&&([e[t+1],e[t+2]]=[e[t+2],e[t+1]])}return s.flat().map(e=>e.shape)}getNearestAdjacentShape(e,t,i){let s={right:0,left:180,down:90,up:270},r=this.getShape(t);if(!r)return t;let n=e.filter(e=>this.getShapeUtil(e).canTabTo(e)&&e.id!==t);if(!n.length)return t;let a=this.getShapePageBounds(r).center,h=n.map(e=>({shape:e,center:this.getShapePageBounds(e).center})).filter(({center:e})=>{let t=e.x>a.x,s=e.y>a.y,r=e.x-a.x,n=e.y-a.y;return"left"===i||"right"===i?Math.abs(n)<2*Math.abs(r)&&("right"===i?t:!t):"up"===i||"down"===i?Math.abs(r)<2*Math.abs(n)&&("down"===i?s:!s):void 0});return 0===h.length?t:(0,ev.F)(h,({center:e})=>{let t=eZ.B.Dist2(a,e),r=["left","right"].includes(i)?"x":"y",n=Math.abs(e[r]-a[r]),h=["left","right"].includes(i)?"y":"x";return 1*t+2*Math.abs(e[h]-a[h])+(t-n)*1.5+.5*Math.abs(Math.abs(eZ.B.Angle(a,e)*(180/Math.PI))-s[i])}).shape.id}selectParentShape(){let e=this.getOnlySelectedShape();if(!e)return;let t=this.getShape(e.parentId);t&&this._selectShapesAndZoom([t.id])}selectFirstChildShape(){let e=this.getSelectedShapes();if(!e.length)return;let t=e[0],i=this.getSortedChildIdsForParent(t.id).map(e=>this.getShape(e)).filter(e=>e),s=this._getShapesInReadingOrder(i);0!==s.length&&this._selectShapesAndZoom([s[0].id])}_selectShapesAndZoom(e){this.setSelectedShapes(e),this.zoomToSelectionIfOffscreen(256,{animation:{duration:this.options.animationMediumMs},inset:0})}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShapeId(){return this.getOnlySelectedShape()?.id??null}getOnlySelectedShape(){let e=this.getSelectedShapes();return 1===e.length?e[0]:null}getShapesPageBounds(e){let t=(0,ev.oA)(e.map(e=>this.getShapePageBounds(e)));return 0===t.length?null:eD.xu.Common(t)}getSelectionPageBounds(){return this.getShapesPageBounds(this.getSelectedShapeIds())}getSelectionScreenBounds(){let e=this.getSelectionPageBounds();if(!e)return;let{x:t,y:i}=this.pageToScreen(e.point),s=this.getZoomLevel();return new eD.xu(t,i,e.width*s,e.height*s)}getShapesSharedRotation(e){let t=!1,i=0;for(let s=0,r=e.length;s<r;s++){let r=this.getShapePageTransform(e[s]);if(r){if(t){if(r.rotation()!==i)return 0}else t=!0,i=r.rotation()}}return i}getSelectionRotation(){return this.getShapesSharedRotation(this.getSelectedShapeIds())}getShapesRotatedPageBounds(e){if(0===e.length)return;let t=this.getShapesSharedRotation(e);if(0===t)return this.getShapesPageBounds(e)??void 0;if(1===e.length){let t=this.getShapeGeometry(e[0]).bounds.clone(),i=this.getShapePageTransform(e[0]);return t.point=i.applyToPoint(t.point),t}let i=eD.xu.FromPoints(e.flatMap(e=>{let t=this.getShapePageTransform(e);return t?t.applyToPoints(this.getShapeGeometry(e).bounds.corners):[]}).map(e=>e.rot(-t)));return i.point=i.point.rot(t),i}getSelectionRotatedPageBounds(){return this.getShapesRotatedPageBounds(this.getSelectedShapeIds())}getSelectionRotatedScreenBounds(){let e=this.getSelectionRotatedPageBounds();if(!e)return;let{x:t,y:i}=this.pageToScreen(e.point),s=this.getZoomLevel();return new eD.xu(t,i,e.width*s,e.height*s)}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){let e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){let t="string"==typeof e?e:e?.id??null;if(null!==t){let e=this.getShape(t);if(!e)throw Error(`Editor.setFocusedGroup: Shape with id ${t} does not exist`);if(!this.isShapeOfType(e,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${e.type}`)}return t===this.getFocusedGroupId()?this:this.run(()=>{this.store.update(this.getCurrentPageState().id,e=>({...e,focusedGroupId:t}))},{history:"record-preserveRedoStack"})}popFocusedGroupId(){let e=this.getFocusedGroup();if(e){let t=this.findShapeAncestor(e,e=>this.isShapeOfType(e,"group"));this.setFocusedGroup(t?.id??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){let e=this.getEditingShapeId();return e?this.getShape(e):void 0}setEditingShape(e){let t="string"==typeof e?e:e?.id??null;this.setRichTextEditor(null);let i=this.getEditingShapeId();if(t!==i){if(t){let e=this.getShape(t);if(e&&this.getShapeUtil(e).canEdit(e))return this.run(()=>{if(this._updateCurrentPageState({editingShapeId:t}),i){let e=this.getShape(i);e&&this.getShapeUtil(e).onEditEnd?.(e)}this.getShapeUtil(e).onEditStart?.(e)},{history:"ignore"}),this}this.run(()=>{if(this._updateCurrentPageState({editingShapeId:null}),this._currentRichTextEditor.set(null),i){let e=this.getShape(i);e&&this.getShapeUtil(e).onEditEnd?.(e)}},{history:"ignore"})}return this}getRichTextEditor(){return this._currentRichTextEditor.get()}setRichTextEditor(e){return this._currentRichTextEditor.set(e),this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){let e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){let t="string"==typeof e?e:e?.id??null;return t===this.getHoveredShapeId()||this.run(()=>{this.updateCurrentPageState({hoveredShapeId:t})},{history:"ignore"}),this}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){let e=this.getHintingShapeIds();return(0,ev.oA)(e.map(e=>this.getShape(e)))}setHintingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.run(()=>{this._updateCurrentPageState({hintingShapeIds:(0,ev.D8)(t)})},{history:"ignore"}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){let e=this.getErasingShapeIds();return(0,ev.oA)(e.map(e=>this.getShape(e)))}setErasingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);t.sort();let i=this.getErasingShapeIds();return this.run(()=>{if(t.length===i.length){for(let e=0;e<t.length;e++)if(t[e]!==i[e]){this._updateCurrentPageState({erasingShapeIds:t});break}}else this._updateCurrentPageState({erasingShapeIds:t})},{history:"ignore"}),this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}setCroppingShape(e){let t="string"==typeof e?e:e?.id??null;return t!==this.getCroppingShapeId()&&this.run(()=>{if(t){let e=this.getShape(t),i=this.getShapeUtil(e);e&&i.canCrop(e)&&this.updateCurrentPageState({croppingShapeId:t})}else this.updateCurrentPageState({croppingShapeId:null})},{history:"ignore"}),this}getTextOptions(){return(0,ev.kP)(this._textOptions.get(),"Cannot use text without setting textOptions")}_unsafe_getCameraId(){return eb.AN.createId(this.getCurrentPageId())}getCamera(){let e=this.store.get(this._unsafe_getCameraId());if(this._isLockedOnFollowingUser.get()){let t=this.getCameraForFollowing();if(t)return{...e,...t}}return e}_getFollowingPresence(e){let t=[this.user.getId()],i=this.getCollaborators(),s=null;for(;e&&!t.includes(e);)s=i.find(t=>t.userId===e)??null,e=s?.followingUserId??null,s&&t.push(s.userId);return s}getViewportPageBoundsForFollowing(){let e=this._getFollowingPresence(this.getInstanceState().followingUserId);if(!e?.camera||!e?.screenBounds)return null;let{w:t,h:i}=e.screenBounds,{x:s,y:r,z:n}=e.camera,a=new eD.xu(-s,-r,t/n,i/n),h=this.getViewportScreenBounds().clone(),o=h.width/h.height;return h.width=a.width,h.height=h.width/o,h.height<a.height&&(h.height=a.height,h.width=h.height*o),h.center=a.center,h}getCameraForFollowing(){let e=this.getViewportPageBoundsForFollowing();return e?{x:-e.x,y:-e.y,z:this.getViewportScreenBounds().w/e.width}:null}getZoomLevel(){return this.getCamera().z}getInitialZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.initialZoom)return 1;let{zx:t,zy:i}=tA(this,e);switch(e.constraints.initialZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,ev.iP)(e.constraints.initialZoom)}}getBaseZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.baseZoom)return 1;let{zx:t,zy:i}=tA(this,e);switch(e.constraints.baseZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,ev.iP)(e.constraints.baseZoom)}}getCameraOptions(){return this._cameraOptions.get()}setCameraOptions(e){let t=(0,ev.v4)({...this._cameraOptions.__unsafe__getWithoutCapture(),...e});return t.zoomSteps?.length<1&&(t.zoomSteps=[1]),this._cameraOptions.set(t),this.setCamera(this.getCamera()),this}getConstrainedCamera(e,t){let i=this.getCamera(),{x:s,y:r,z:n=i.z}=e;if(!t?.force){let e=this.getCameraOptions(),a=e.zoomSteps[0],h=(0,ev.Z$)(e.zoomSteps),o=this.getViewportScreenBounds();if(e.constraints){let{constraints:l}=e,p=Math.min(l.padding.y,o.w/2),g=Math.min(l.padding.x,o.h/2),d=eD.xu.From(e.constraints.bounds),u=(o.w-2*g)/d.w,c=(o.h-2*p)/d.h,S=this.getBaseZoom(),f=h*S,m=a*S;if(t?.reset&&(n=this.getInitialZoom()),n<m||n>f){let{x:e,y:t,z:a}=i,h=-e+o.w/a/2,l=-t+o.h/a/2;n=(0,eX.uZ)(n,m,f);let p=-e+o.w/n/2,g=-t+o.h/n/2;s=e+p-h,r=t+g-l}let y=g/n-d.x,I=p/n-d.y,P=(o.w-2*g)/n-d.w,C=(o.h-2*p)/n-d.h,w=y+P*l.origin.x,_=I+C*l.origin.y,B="string"==typeof l.behavior?l.behavior:l.behavior.x,T="string"==typeof l.behavior?l.behavior:l.behavior.y;if(t?.reset)s=w,r=_;else{switch(B){case"fixed":s=w;break;case"contain":s=n<u?w:(0,eX.uZ)(s,y+P,y);break;case"inside":s=n<u?(0,eX.uZ)(s,y,(o.w-g)/n-d.w):(0,eX.uZ)(s,y+P,y);break;case"outside":s=(0,eX.uZ)(s,g/n-d.w,(o.w-g)/n);break;case"free":break;default:throw(0,ev.iP)(B)}switch(T){case"fixed":r=_;break;case"contain":r=n<c?_:(0,eX.uZ)(r,I+C,I);break;case"inside":r=n<c?(0,eX.uZ)(r,I,(o.h-p)/n-d.h):(0,eX.uZ)(r,I+C,I);break;case"outside":r=(0,eX.uZ)(r,p/n-d.h,(o.h-p)/n);break;case"free":break;default:throw(0,ev.iP)(T)}}}else if(n>h||n<a){let{x:e,y:t,z:l}=i;n=(0,eX.uZ)(n,a,h),s=e+(-e+o.w/n/2)-(-e+o.w/l/2),r=t+(-t+o.h/n/2)-(-t+o.h/l/2)}}return{x:s,y:r,z:n}}_setCamera(e,t){let i=this.getCamera(),{x:s,y:r,z:n}=this.getConstrainedCamera(e,t);return i.x===s&&i.y===r&&i.z===n||(0,eB.ay)(()=>{let e={...i,x:s,y:r,z:n};this.run(()=>{this.store.put([e])},{history:"ignore"});let{currentScreenPoint:a,currentPagePoint:h}=this.inputs,{screenBounds:o}=this.store.unsafeGetWithoutCapture(eb.PQ);if(a.x/n-s!==h.x||a.y/n-r!==h.y){let e={type:"pointer",target:"canvas",name:"pointer_move",point:eZ.B.AddXY(a,o.x,o.y),pointerId:eE.CK.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),button:0,isPen:this.getInstanceState().isPenMode??!1};t?.immediate?this._flushEventForTick(e):this.dispatch(e)}this._tickCameraState()}),this}setCamera(e,t){let{isLocked:i}=this._cameraOptions.__unsafe__getWithoutCapture();if(i&&!t?.force)return this;this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser();let s=eZ.B.Cast(e);Number.isFinite(s.x)||(s.x=0),Number.isFinite(s.y)||(s.y=0),void 0!==s.z&&Number.isFinite(s.z)||(e.z=this.getZoomLevel());let r=this.getConstrainedCamera(s,t);if(t?.animation){let{width:e,height:i}=this.getViewportScreenBounds();this._animateToViewport(new eD.xu(-r.x,-r.y,e/r.z,i/r.z),t)}else this._setCamera(r,{...t,force:!0});return this}centerOnPoint(e,t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{width:s,height:r}=this.getViewportPageBounds();return this.setCamera(new eZ.B(-(e.x-s/2),-(e.y-r/2),this.getCamera().z),t),this}zoomToFit(e){let t=[...this.getCurrentPageShapeIds()];if(t.length<=0)return this;let i=eD.xu.Common((0,ev.oA)(t.map(e=>this.getShapePageBounds(e))));return this.zoomToBounds(i,e),this}resetZoom(e=this.getViewportScreenCenter(),t){let{isLocked:i,constraints:s}=this.getCameraOptions();if(i&&!t?.force)return this;let{x:r,y:n,z:a}=this.getCamera(),{x:h,y:o}=e,l=1;if(s){let e=this.getInitialZoom();a!==e&&(l=e)}return this.setCamera(new eZ.B(r+(h/l-h)-(h/a-h),n+(o/l-o)-(o/a-o),l),t),this}zoomIn(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{x:s,y:r,z:n}=this.getCamera(),{zoomSteps:a}=this.getCameraOptions();if(null!==a&&a.length>1){let i=this.getBaseZoom(),h=(0,ev.Z$)(a)*i;for(let e=1;e<a.length;e++){let t=a[e-1]*i,s=a[e]*i;if(!(s-n<=(s-t)/2)){h=s;break}}this.setCamera(new eZ.B(s+(e.x/h-e.x)-(e.x/n-e.x),r+(e.y/h-e.y)-(e.y/n-e.y),h),t)}return this}zoomOut(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{zoomSteps:s}=this.getCameraOptions();if(null!==s&&s.length>1){let i=this.getBaseZoom(),{x:r,y:n,z:a}=this.getCamera(),h=s[0]*i;for(let e=s.length-1;e>0;e--){let t=s[e-1]*i,r=s[e]*i;if(!(r-a>=(r-t)/2)){h=t;break}}this.setCamera(new eZ.B(r+(e.x/h-e.x)-(e.x/a-e.x),n+(e.y/h-e.y)-(e.y/a-e.y),h),t)}return this}zoomToSelection(e){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force)return this;let i=this.getSelectionPageBounds();return i&&this.zoomToBounds(i,{targetZoom:Math.max(1,this.getZoomLevel()),...e}),this}zoomToSelectionIfOffscreen(e=16,t){let i=this.getSelectionPageBounds(),s=this.getViewportPageBounds();if(i&&!s.contains(i)){let r=i.clone().expandBy(e/this.getZoomLevel()).expand(s),n=s.clone().translate({x:(r.center.x-s.center.x)*2,y:(r.center.y-s.center.y)*2});this.zoomToBounds(n,t)}}zoomToBounds(e,t){let i=this._cameraOptions.__unsafe__getWithoutCapture();if(i.isLocked&&!t?.force)return this;let s=this.getViewportScreenBounds(),r=t?.inset??Math.min(eE.TP,.28*s.width),n=this.getBaseZoom(),a=i.zoomSteps[0],h=(0,ev.Z$)(i.zoomSteps),o=(0,eX.uZ)(Math.min((s.width-r)/e.w,(s.height-r)/e.h),a*n,h*n);return t?.targetZoom!==void 0&&(o=Math.min(t.targetZoom,o)),this.setCamera(new eZ.B(-e.x+(s.width-e.w*o)/2/o,-e.y+(s.height-e.h*o)/2/o,o),t),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_animateViewport(e){if(!this._viewportAnimation)return;this._viewportAnimation.elapsed+=e;let{elapsed:t,easing:i,duration:s,start:r,end:n}=this._viewportAnimation;if(t>s){this.off("tick",this._animateViewport),this._viewportAnimation=null,this._setCamera(new eZ.B(-n.x,-n.y,this.getViewportScreenBounds().width/n.width));return}let a=i(1-(s-t)/s),h=r.minX+(n.minX-r.minX)*a,o=r.minY+(n.minY-r.minY)*a,l=r.maxX+(n.maxX-r.maxX)*a;this._setCamera(new eZ.B(-h,-o,this.getViewportScreenBounds().width/(l-h)),{force:!0})}_animateToViewport(e,t={animation:eE.Xy}){let{animation:i,...s}=t;if(!i)return;let{duration:r=0,easing:n=eG.L.easeInOutCubic}=i,a=this.user.getAnimationSpeed(),h=this.getViewportPageBounds();return(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),0===r||0===a)?this._setCamera(new eZ.B(-e.x,-e.y,this.getViewportScreenBounds().width/e.width),{...s}):(this._viewportAnimation={elapsed:0,duration:r/a,easing:n,start:h.clone(),end:e.clone()},this.once("stop-camera-animation",()=>{this.off("tick",this._animateViewport),this._viewportAnimation=null}),this.on("tick",this._animateViewport),this)}slideCamera(e={}){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force||0===this.user.getAnimationSpeed())return this;this.stopCameraAnimation();let{speed:i,friction:s=this.options.cameraSlideFriction,direction:r,speedThreshold:n=.01}=e,a=Math.min(i,1),h=()=>{this.off("tick",o),this.off("stop-camera-animation",h)};this.once("stop-camera-animation",h);let o=e=>{let{x:t,y:i,z:o}=this.getCamera(),l=eZ.B.Mul(r,a*e/o);(a*=1-s)<n?h():this._setCamera(new eZ.B(t+l.x,i+l.y,o))};return this.on("tick",o),this}zoomToUser(e,t={animation:{duration:500}}){let i=this.getCollaborators().find(t=>t.userId===e);if(!i)return this;let s=i.cursor;return s&&this.run(()=>{null!==this.getInstanceState().followingUserId&&this.stopFollowingUser();let r=i.currentPageId===this.getCurrentPageId();r||this.setCurrentPage(i.currentPageId),t&&t.animation&&!r&&(t.animation=void 0),this.centerOnPoint(s,t);let{highlightedUserIds:n}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...n,e]}),this.timers.setTimeout(()=>{let t=[...this.getInstanceState().highlightedUserIds],i=t.indexOf(e);i<0||(t.splice(i,1),this.updateInstanceState({highlightedUserIds:t}))},this.options.collaboratorIdleTimeoutMs)}),this}updateViewportScreenBounds(e,t=!1){if(e instanceof eD.xu)e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);else{let t=e.getBoundingClientRect();e=new eD.xu(t.left||t.x,t.top||t.y,Math.max(t.width,1),Math.max(t.height,1))}let i=[0!==e.minY,!(0,eX.C2)(document.body.scrollWidth,e.maxX,1),!(0,eX.C2)(document.body.scrollHeight,e.maxY,1),0!==e.minX],{_willSetInitialBounds:s}=this;this._willSetInitialBounds=!1;let{screenBounds:r,insets:n}=this.getInstanceState();if(e.equals(r)&&i.every((e,t)=>e===n[t]))return this;if(s)this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.setCamera(this.getCamera());else if(t&&!this.getInstanceState().followingUserId){let t=this.getViewportPageBounds().center;this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.centerOnPoint(t)}else this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this._setCamera(eZ.B.From({...this.getCamera()}));return this._tickCameraState(),this}getViewportScreenBounds(){let{x:e,y:t,w:i,h:s}=this.getInstanceState().screenBounds;return new eD.xu(e,t,i,s)}getViewportScreenCenter(){let e=this.getViewportScreenBounds();return new eZ.B(e.w/2,e.h/2)}getViewportPageBounds(){let{w:e,h:t}=this.getViewportScreenBounds(),{x:i,y:s,z:r}=this.getCamera();return new eD.xu(-i,-s,e/r,t/r)}screenToPage(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(eb.PQ),{x:i,y:s,z:r=1}=this.getCamera();return new eZ.B((e.x-t.x)/r-i,(e.y-t.y)/r-s,e.z??.5)}pageToScreen(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(eb.PQ),{x:i,y:s,z:r=1}=this.getCamera();return new eZ.B((e.x+i)*r+t.x,(e.y+s)*r+t.y,e.z??.5)}pageToViewport(e){let{x:t,y:i,z:s=1}=this.getCamera();return new eZ.B((e.x+t)*s,(e.y+i)*s,e.z??.5)}_getCollaboratorsQuery(){return this.store.query.records("instance_presence",()=>({userId:{neq:this.user.getId()}}))}getCollaborators(){let e=this._getCollaboratorsQuery().get();return e.length?[...new Set(e.map(e=>e.userId))].sort().map(t=>(0,ev.UT)(e.filter(e=>e.userId===t),e=>e.lastActivityTimestamp??0)):eB.LZ}getCollaboratorsOnCurrentPage(){let e=this.getCurrentPageId();return this.getCollaborators().filter(t=>t.currentPageId===e)}startFollowingUser(e){if(this.stopFollowingUser(),this.user.getId()||console.warn("You should set the userId for the current instance before following a user"),!this._getFollowingPresence(e))return this;let t=(0,eB.Fl)("latestLeaderPresence",()=>this._getFollowingPresence(e));return(0,eB.ay)(()=>{this.updateInstanceState({followingUserId:e},{history:"ignore"});let i=(0,eB.Ym)("update current page",()=>{let e=t.get();if(!e){this.stopFollowingUser();return}e.currentPageId!==this.getCurrentPageId()&&this.getPage(e.currentPageId)&&this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:e.currentPageId}]),this._isLockedOnFollowingUser.set(!0)},{history:"ignore"})}),s=()=>{i(),this._isLockedOnFollowingUser.set(!1),this.off("frame",r),this.off("stop-following",s)},r=()=>{if(!t.get()){this.stopFollowingUser();return}if(this._isLockedOnFollowingUser.get())return;let e=this.user.getAnimationSpeed();if(0===e){this._isLockedOnFollowingUser.set(!0);return}let i=this.getViewportPageBoundsForFollowing();if(!i){this.stopFollowingUser();return}let s=this.getViewportPageBounds(),r=Math.abs(i.minX-s.minX)+Math.abs(i.maxX-s.maxX),n=Math.abs(i.minY-s.minY)+Math.abs(i.maxY-s.maxY);if(r<this.options.followChaseViewportSnap&&n<this.options.followChaseViewportSnap){this._isLockedOnFollowingUser.set(!0);return}let a=(0,eX.uZ)(.5*e,.1,.8),h=new eD.xu((0,ev.t7)(s.minX,i.minX,a),(0,ev.t7)(s.minY,i.minY,a),(0,ev.t7)(s.width,i.width,a),(0,ev.t7)(s.height,i.height,a)),o=new eZ.B(-h.x,-h.y,this.getViewportScreenBounds().width/h.width);this.stopCameraAnimation(),this._setCamera(o)};this.once("stop-following",s),this.addListener("frame",r),r()}),this}stopFollowingUser(){return this.run(()=>{this.store.put([this.getCamera()]),this._isLockedOnFollowingUser.set(!1),this.updateInstanceState({followingUserId:null}),this.emit("stop-following")},{history:"ignore"}),this}getUnorderedRenderingShapes(e){let t=[],i=2*this.options.maxShapesPerPage,s=this.options.maxShapesPerPage,r=this.getErasingShapeIds(),n=(a,h,o)=>{let l=this.getShape(a);if(!l)return;if(this.isShapeHidden(l)){let e=o||r.includes(a);for(let t of this.getSortedChildIdsForParent(a))n(t,h,e);return}h*=l.opacity;let p=!1,g=this.getShapeUtil(l);e&&(p=!o&&r.includes(a))&&(h*=.32),t.push({id:a,shape:l,util:g,index:i,backgroundIndex:s,opacity:h}),i+=1,s+=1;let d=this.getSortedChildIdsForParent(a);if(!d.length)return;let u=null;for(let e of(g.providesBackgroundForChildren(l)&&(u=s,s=i,i+=this.options.maxShapesPerPage),d))n(e,h,o||p);null!==u&&(s=u)};for(let t of e?[this.getCurrentPage()]:this.getPages())for(let e of this.getSortedChildIdsForParent(t.id))n(e,1,!1);return t}_decayCameraStateTimeout(e){this._cameraStateTimeoutRemaining-=e,this._cameraStateTimeoutRemaining>0||(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"))}_tickCameraState(){this._cameraStateTimeoutRemaining=this.options.cameraMovingTimeoutMs,"idle"===this._cameraState.__unsafe__getWithoutCapture()&&(this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout))}getCameraState(){return this._cameraState.get()}getRenderingShapes(){return this.getUnorderedRenderingShapes(!0).sort(ev.uv)}_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return Array.from(this._getAllPagesQuery().get()).sort(ev.hl)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get("string"==typeof e?e:e.id)}getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getCurrentPageShapeIdsSorted(){return Array.from(this.getCurrentPageShapeIds()).sort()}getPageShapeIds(e){let t="string"==typeof e?e:e.id,i=this.store.query.exec("shape",{parentId:{eq:t}});return this.getShapeAndDescendantIds(i.map(e=>e.id))}setCurrentPage(e){let t="string"==typeof e?e:e.id;return this.store.has(t)?(this.stopFollowingUser(),this.complete(),this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:t}]),this.setCamera(this.getCamera())},{history:"record-preserveRedoStack"})):(console.error("Tried to set the current page id to a page that doesn't exist."),this)}updatePage(e){return this.getIsReadonly()||!this.getPage(e.id)?this:this.run(()=>this.store.update(e.id,t=>({...t,...e})))}createPage(e){return this.run(()=>{if(this.getIsReadonly()||this.getPages().length>=this.options.maxPages)return;let t=this.getPages(),i=(0,eJ.u)(e.name??"Page 1",t.map(e=>e.name)),s=e.index;(!s||t.some(e=>e.index===s))&&(s=(0,ev._L)(t[t.length-1].index));let r=eb.ez.create({meta:{},...e,name:i,index:s});this.store.put([r])}),this}deletePage(e){let t="string"==typeof e?e:e.id;return this.run(()=>{if(this.getIsReadonly())return;let e=this.getPages();if(1===e.length)return;let i=this.getPage(t);if(i){if(t===this.getCurrentPageId()){let i=e.findIndex(e=>e.id===t),s=e[i-1]??e[i+1];this.setCurrentPage(s.id)}this.store.remove([i.id])}}),this}duplicatePage(e,t=eb.ez.createId()){if(this.getPages().length>=this.options.maxPages)return this;let i="string"==typeof e?e:e.id,s=this.getPage(i);if(!s)return this;let r={...this.getCamera()},n=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(s.id));return this.run(()=>{let e=this.getPages(),i=(0,ev.eI)(s.index,e[e.indexOf(s)+1]?.index);if(this.createPage({name:s.name+" Copy",id:t,index:i}),this.setCurrentPage(t),this.setCamera(r),n)return this.putContentOntoCurrentPage(n)}),this}renamePage(e,t){let i="string"==typeof e?e:e.id;return this.getIsReadonly()||this.updatePage({id:i,name:t}),this}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this.getIsReadonly()||e.length<=0||this.run(()=>this.store.put(e),{history:"ignore"}),this}updateAssets(e){return this.getIsReadonly()||e.length<=0||this.run(()=>{this.store.put(e.map(e=>({...this.store.get(e.id),...e})))},{history:"ignore"}),this}deleteAssets(e){if(this.getIsReadonly())return this;let t="string"==typeof e[0]?e:e.map(e=>e.id);return t.length<=0||this.run(()=>{this.store.props.assets.remove?.(t),this.store.remove(t)},{history:"ignore"}),this}getAsset(e){return this.store.get("string"==typeof e?e:e.id)}async resolveAssetUrl(e,t){if(!e)return null;let i=this.getAsset(e);if(!i)return null;let{screenScale:s=1,shouldResolveToOriginal:r=!1,dpr:n=this.getInstanceState().devicePixelRatio}=t,a=Math.pow(2,Math.ceil(Math.log2(s))),h="connection"in navigator?navigator.connection.effectiveType:null;return await this.store.props.assets.resolve(i,{screenScale:s||1,steppedScreenScale:a,dpr:n,networkEffectiveType:h,shouldResolveToOriginal:r})}async uploadAsset(e,t,i){return await this.store.props.assets.upload(e,t,i)}getShapeGeometry(e,t){let i=t?.context??"none";return this._shapeGeometryCaches[i]||(this._shapeGeometryCaches[i]=this.store.createComputedCache("bounds",e=>(this.fonts.trackFontsForShape(e),this.getShapeUtil(e).getGeometry(e,t)),{areRecordsEqual:ej.e})),this._shapeGeometryCaches[i].get("string"==typeof e?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>this.getShapeUtil(e).getHandles?.(e),{areRecordsEqual:ej.e})}getShapeHandles(e){return this._getShapeHandlesCache().get("string"==typeof e?e:e.id)}getShapeLocalTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);if(!i)throw Error("Editor.getTransform: shape not found");return eH._.Identity().translate(i.x,i.y).rotate(i.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if((0,eb.r5)(e.parentId))return this.getShapeLocalTransform(e);let t=this._getShapePageTransformCache().get(e.parentId)??eH._.Identity();return eH._.Compose(t,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);return!i||(0,eb.r5)(i.parentId)?eH._.Identity():this._getShapePageTransformCache().get(i.parentId)??eH._.Identity()}getShapePageTransform(e){let t="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(t)??eH._.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{let t=this.getShapePageTransform(e);if(!t)return;let i=this.getShapeGeometry(e);return eD.xu.FromPoints(t.applyToPoints(i.vertices))})}getShapePageBounds(e){return this._getShapePageBoundsCache().get("string"==typeof e?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{let t=this._getShapeMaskCache().get(e.id);if(!t)return;if(0===t.length)return"polygon(0px 0px, 0px 0px, 0px 0px)";let i=this._getShapePageTransformCache().get(e.id);if(!i)return;let s=eH._.applyToPoints(eH._.Inverse(i),t);return`polygon(${s.map(e=>`${e.x}px ${e.y}px`).join(",")})`})}getShapeClipPath(e){return this._getShapeClipPathCache().get("string"==typeof e?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if((0,eb.r5)(e.parentId))return;let t=this.getShapeAncestors(e.id).filter(e=>this.isShapeOfType(e,"frame"));if(0!==t.length)return t.map(e=>{let t=this.getShapeGeometry(e.id);return this.getShapePageTransform(e.id).applyToPoints(t.vertices)}).reduce((e,t)=>{if(!(t&&e))return;let i=(0,eY.tY)(e,t);return i?i.map(eZ.B.Cast):[]})})}getShapeMask(e){return this._getShapeMaskCache().get("string"==typeof e?e:e.id)}getShapeMaskedPageBounds(e){return"string"!=typeof e&&(e=e.id),this._getShapeMaskedPageBoundsCache().get(e)}_getShapeMaskedPageBoundsCache(){return this.store.createComputedCache("shapeMaskedPageBoundsCache",e=>{let t=this._getShapePageBoundsCache().get(e.id);if(!t)return;let i=this._getShapeMaskCache().get(e.id);if(i){if(0===i.length)return;let{corners:e}=t;if(e.every((e,t)=>e&&eZ.B.Equals(e,i[t])))return t.clone();let s=(0,eY.tY)(i,e);if(!s)return;return eD.xu.FromPoints(s)}return t})}getShapeAncestors(e,t=[]){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return t;let r=s.parentId;if((0,eb.r5)(r))return t.reverse(),t;let n=this.store.get(r);return n?(t.push(n),this.getShapeAncestors(n,t)):t}findShapeAncestor(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return;let r=s.parentId;if((0,eb.r5)(r))return;let n=this.getShape(r);if(n)return t(n)?n:this.findShapeAncestor(n,t)}hasAncestor(e,t){let i="string"==typeof e?e:e?.id,s=i&&this.getShape(i);return!!s&&(s.parentId===t||this.hasAncestor(this.getShapeParent(s),t))}findCommonAncestor(e,t){if(0===e.length)return;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,ev.oA)(i.map(e=>this.getShape(e)));if(1===s.length){let e=s[0].parentId;if((0,eb.r5)(e))return;return t?this.findShapeAncestor(s[0],t)?.id:e}let[r,...n]=s,a=this.getShapeParent(r);for(;a;){if(t&&!t(a)){a=this.getShapeParent(a);continue}if(n.every(e=>this.hasAncestor(e,a.id)))return a.id;a=this.getShapeParent(a)}}isShapeOrAncestorLocked(e){let t=e&&this.getShape(e);return void 0!==t&&(!!t.isLocked||this.isShapeOrAncestorLocked(this.getShapeParent(t)))}getNotVisibleShapes(){return this._notVisibleShapes.get()}getCulledShapes(){let e=this.getNotVisibleShapes(),t=this.getSelectedShapeIds(),i=this.getEditingShapeId(),s=new Set(e);return i&&s.delete(i),t.forEach(e=>{s.delete(e)}),s}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIdsSorted().forEach(t=>{let i=this.getShapeMaskedPageBounds(t);i&&(e=e?e.expand(i):i.clone())}),e}getSelectedShapeAtPoint(e){let t=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(e=>"group"!==e.type&&t.includes(e.id)).reverse().find(t=>this.isPointInShape(t,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,t={}){let i=this.getZoomLevel(),s=this.getViewportPageBounds(),{filter:r,margin:n=0,hitLocked:a=!1,hitLabels:h=!1,hitInside:o=!1,hitFrameInside:l=!1}=t,p=1/0,g=null,d=1/0,u=null,c=(t.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(t=>{if(t.isLocked&&!a||this.isShapeHidden(t)||this.isShapeOfType(t,"group"))return!1;let i=this.getShapeMask(t);return(!i||!!(0,eX.Of)(e,i))&&(!r||r(t))});for(let t=c.length-1;t>=0;t--){let r;let a=c[t],S=this.getShapeGeometry(a),f=S instanceof eN.m,m=this.getPointInShapeSpace(a,e);if(this.isShapeOfType(a,"frame")||this.isShapeOfType(a,"arrow")&&a.props.text.trim()||(this.isShapeOfType(a,"note")||this.isShapeOfType(a,"geo")&&"none"===a.props.fill)&&this.getShapeUtil(a).getText(a)?.trim()){for(let e of S.children)if(e.isLabel&&e.isPointInBounds(m))return a}if(this.isShapeOfType(a,"frame")){if(Math.abs(S.distanceToPoint(m,o))<=n)return u||a;if(S.hitTestPoint(m,0,!0))return u||g||(l?a:void 0);continue}if(f){let e=1/0;for(let t of S.children){if(t.isLabel&&!h)continue;let i=t.distanceToPoint(m,o);i<e&&(e=i)}r=e}else r=0===n&&(S.bounds.w<1||S.bounds.h<1)?S.distanceToPoint(m,o):S.bounds.containsPoint(m,n)?S.distanceToPoint(m,o):1/0;if(S.isClosed){if(r<=n){if(S.isFilled||f&&S.children[0].isFilled)return u||a;if(this.getShapePageBounds(a).contains(s))continue;if(Math.abs(r)<n)Math.abs(r)<d&&(d=Math.abs(r),u=a);else if(!u){let{area:e}=S;e<p&&(p=e,g=a)}}}else if(r<this.options.hitTestMargin/i)return a}return u||g||void 0}getShapesAtPoint(e,t={}){return this.getCurrentPageShapesSorted().filter(i=>!this.isShapeHidden(i)&&this.isPointInShape(i,e,t)).reverse()}isPointInShape(e,t,i={}){let{hitInside:s=!1,margin:r=0}=i,n="string"==typeof e?e:e.id,a=this.getShapeMask(n);return(!a||!!(0,eX.Of)(t,a))&&this.getShapeGeometry(n).hitTestPoint(this.getPointInShapeSpace(e,t),r,s)}getPointInShapeSpace(e,t){let i="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(i).clone().invert().applyToPoint(t)}getPointInParentSpace(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return new eZ.B(0,0);if((0,eb.r5)(s.parentId))return eZ.B.From(t);let r=this.getShapePageTransform(s.parentId);return r?r.clone().invert().applyToPoint(t):eZ.B.From(t)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){let e=[],t=this.getSortedChildIdsForParent(this.getCurrentPageId());for(let i=0,s=t.length;i<s;i++)!function e(t,i,s){let r=t.getShape(i);if(!r)return;s.push(r);let n=t.getSortedChildIdsForParent(i);for(let i=0,r=n.length;i<r;i++)e(t,n[i],s)}(this,t[i],e);return e}getCurrentPageRenderingShapesSorted(){let e=this.getCulledShapes();return this.getCurrentPageShapesSorted().filter(({id:t})=>!e.has(t)&&!this.isShapeHidden(t))}isShapeOfType(e,t){let i="string"==typeof e?this.getShape(e):e;return!!i&&i.type===t}getShape(e){let t="string"==typeof e?e:e.id;if((0,eb.YT)(t))return this.store.get(t)}getShapeParent(e){let t="string"==typeof e?e:e?.id;if(!t)return;let i=this.getShape(t);if(void 0!==i&&(0,eb.YT)(i.parentId))return this.getShape(i.parentId)}getShapeNearestSibling(e,t){return t?t.parentId===e.parentId?t:this.findShapeAncestor(t,t=>t.parentId===e.parentId):void 0}isShapeInPage(e,t=this.getCurrentPageId()){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return!1;let r=!1;if(s.parentId===t)r=!0;else{let e=this.getShape(s.parentId);for(;e;){if(e.parentId===t){r=!0;break}e=this.getShape(e.parentId)}}return r}getAncestorPageId(e){let t="string"==typeof e?e:e?.id,i=t&&this.getShape(t);if(i)return(0,eb.r5)(i.parentId)?i.parentId:this.getAncestorPageId(this.getShape(i.parentId))}reparentShapes(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(0===s.length)return this;let r=[],n=(0,eb.r5)(t)?eH._.Identity():this.getShapePageTransform(t),a=n.rotation(),h=[],o=(0,ev.oA)(this.getSortedChildIdsForParent(t).map(e=>this.getShape(e)));if(i){let e=o.find(e=>e.index===i);if(e){let t=o[o.indexOf(e)+1];h=t?(0,ev.Xv)(i,t.index,s.length):(0,ev.vw)(i,s.length)}else{let e=o.sort(ev.hl).find(e=>e.index>i);h=e?(0,ev.Xv)(i,e.index,s.length):(0,ev.vw)(i,s.length)}}else{let e=o.length&&o[o.length-1];h=e?(0,ev.vw)(e.index,s.length):(0,ev.H$)(s.length)}let l=n.clone().invert(),p=(0,ev.oA)(s.map(e=>this.getShape(e))).sort(ev.hl);return this.run(()=>{for(let e=0;e<p.length;e++){let i=p[e],s=this.getShapePageTransform(i);if(!s)continue;let n=s.point();if(!n)continue;let o=l.applyToPoint(n),g=s.rotation()-a;if(i.id===t)throw Error("Attempted to reparent a shape to itself!");r.push({id:i.id,type:i.type,parentId:t,x:o.x,y:o.y,rotation:g,index:h[e]})}this.updateShapes(r)},{ignoreShapeLock:!0}),this}getHighestIndexForParent(e){let t="string"==typeof e?e:e.id,i=this._parentIdsToChildIds.get()[t];if(!i||0===i.length)return"a1";let s=this.getShape(i[i.length-1]);return(0,ev._L)(s.index)}getSortedChildIdsForParent(e){let t="string"==typeof e?e:e.id;return this._parentIdsToChildIds.get()[t]||eB.LZ}visitDescendants(e,t){for(let i of this.getSortedChildIdsForParent(e))!1!==t(i)&&this.visitDescendants(i,t);return this}getShapeAndDescendantIds(e){let t=new Set;for(let i of e.map(e=>this.getShape(e)).sort(ev.hl))t.add(i.id),this.visitDescendants(i,e=>{t.add(e)});return t}getDroppingOverShape(e,t){return this.getDraggingOverShape(e,t)}getDraggingOverShape(e,t){let i=(0,ev.oA)(t.map(e=>this.getShape(e))).filter(e=>!e.isLocked&&!this.isShapeHidden(e));for(let s of this.getShapesAtPoint(e,{hitInside:!0,margin:0}).filter(e=>!t.includes(e)&&!e.isLocked&&!this.isShapeHidden(e)&&!i.includes(e))){let e=this.getShapeUtil(s);if(e.onDragShapesOver||e.onDragShapesIn||e.onDragShapesOut||e.onDropShapesOver)return s}}getOutermostSelectableShape(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i),r=s,n=s,a=this.getFocusedGroup();for(;n;){if(this.isShapeOfType(n,"group")&&a?.id!==n.id&&!this.hasAncestor(a,n.id)&&(t?.(n)??!0))r=n;else if(a?.id===n.id)break;n=this.getShapeParent(n)}return r}_getBindingsIndexCache(){let e=(0,e5.f)(this);return this.store.createComputedCache("bindingsIndex",t=>e.get().get(t.id),{areRecordsEqual:()=>!0})}getBinding(e){return this.store.get(e)}getBindingsFromShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.fromId===i&&e.type===t)}getBindingsToShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.toId===i&&e.type===t)}getBindingsInvolvingShape(e,t){let i="string"==typeof e?e:e.id,s=this._getBindingsIndexCache().get(i)??eB.LZ;return t?s.filter(e=>e.type===t):s}createBindings(e){let t=[];for(let i of e){let e=this.getShape(i.fromId),s=this.getShape(i.toId);if(!e||!s||!this.canBindShapes({fromShape:e,toShape:s,binding:i}))continue;let r=this.getBindingUtil(i.type).getDefaultProps(),n=this.store.schema.types.binding.create({...i,id:i.id??(0,eb.vI)(),props:{...r,...i.props}});t.push(n)}return this.store.put(t),this}createBinding(e){return this.createBindings([e])}updateBindings(e){let t=[];for(let i of e){if(!i)continue;let e=this.getBinding(i.id);if(!e)continue;let s=tk(e,i);if(s===e)continue;let r=this.getShape(s.fromId),n=this.getShape(s.toId);r&&n&&this.canBindShapes({fromShape:r,toShape:n,binding:s})&&t.push(s)}return this.store.put(t),this}updateBinding(e){return this.updateBindings([e])}deleteBindings(e,{isolateShapes:t=!1}={}){let i=e.map(e=>"string"==typeof e?e:e.id);return t?this.store.atomic(()=>{for(let e of i){let t=this.getBinding(e);if(!t)continue;let i=this.getBindingUtil(t);i.onBeforeIsolateFromShape?.({binding:t,removedShape:this.getShape(t.toId)}),i.onBeforeIsolateToShape?.({binding:t,removedShape:this.getShape(t.fromId)}),this.store.remove([e])}}):this.store.remove(i),this}deleteBinding(e,t){return this.deleteBindings([e],t)}canBindShapes({fromShape:e,toShape:t,binding:i}){let s="string"==typeof e?e:e.type,r="string"==typeof t?t:t.type,n={fromShapeType:s,toShapeType:r,bindingType:"string"==typeof i?i:i.type};return s===r?this.getShapeUtil(s).canBind(n):this.getShapeUtil(s).canBind(n)&&this.getShapeUtil(r).canBind(n)}rotateShapesBy(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(s.length<=0)return this;let r=(0,e2.o)({editor:this,ids:s});return r&&(0,e2.Z)({delta:t,snapshot:r,editor:this,stage:"one-off",centerOverride:i?.center}),this}getChangesToTranslateShape(e,t){let i=e,s=this.getShapeUtil(e),r=s.onTranslateStart?.(i);r&&(i=tk(i,r)),i=tk(i,{id:e.id,type:e.type,x:t.x,y:t.y});let n=s.onTranslate?.(e,i);n&&(i=tk(i,n));let a=s.onTranslateEnd?.(e,i);return a&&(i=tk(i,a)),i}nudgeShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=[];for(let e of i){let i=this.getShape(e),r=eZ.B.From(t),n=this.getShapeParentTransform(i);n&&r.rot(-n.rotation()),s.push(this.getChangesToTranslateShape(i,r.add(i)))}return this.updateShapes(s),this}duplicateShapes(e,t){return this.run(()=>{let i="string"==typeof e[0]?e:e.map(e=>e.id),s=this._shouldIgnoreShapeLock?i:this._getUnlockedShapeIds(i);if(s.length<=0)return this;let r=new Set(s),n=this.getShapeAndDescendantIds(s),a=[...n].reverse(),h=new Map;for(let e of n)h.set(e,(0,eb.F1)());let{shapesToCreateWithOriginals:o,bindingsToCreate:l}=tF(this,n,e=>{let i=[];for(let t of e){let e=this.getBinding(t);if(!e)continue;let s=(0,eb.vI)();i.push({...e,id:s,fromId:(0,ev.kP)(h.get(e.fromId)),toId:(0,ev.kP)(h.get(e.toId))})}let s=[];for(let e of a){let i=(0,ev.kP)(h.get(e)),n=this.getShape(e);if(!n)continue;let a=0,o=0;if(t&&r.has(e)){let e=this.getShapeParentTransform(n),i=new eZ.B(t.x,t.y).rot(-e.rotation());a=i.x,o=i.y}s.push({shape:{...n,id:i,x:n.x+a,y:n.y+o,index:"a1",parentId:h.get(n.parentId)??n.parentId},originalShape:n})}return{shapesToCreateWithOriginals:s,bindingsToCreate:i}});o.forEach(({shape:e,originalShape:t})=>{let i=t.parentId,s=this.getSortedChildIdsForParent(i),r=s.indexOf(t.id),n=s[r+1],a=n?this.getShape(n):void 0,h=(0,ev.eI)(t.index,a?.index);e.index=h});let p=o.map(({shape:e})=>e);if(!this.canCreateShapes(p)){tv(this);return}if(this.createShapes(p),this.createBindings(l),this.setSelectedShapes((0,ev.oA)(s.map(e=>h.get(e)))),void 0!==t){let e=this.getSelectionPageBounds(),t=this.getViewportPageBounds();e&&!t.contains(e)&&this.centerOnPoint(e.center,{animation:{duration:this.options.animationMediumMs}})}}),this}moveShapesToPage(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(0===i.length||this.getIsReadonly()||t===this.getCurrentPageId()||!this.store.has(t))return this;let s=this.getContentFromCurrentPage(i);if(!s)return this;if(this.getPageShapeIds(t).size+s.shapes.length>this.options.maxShapesPerPage)return tv(this,t),this;let r=this.getCamera().z;return this.run(()=>{this.deleteShapes(i),this.setCurrentPage(t),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(s,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:r}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly()||0===t.length)return this;let i=!0,s=!0,r=[];for(let e of t){let t=this.getShape(e);t&&(r.push(t),t.isLocked?s=!1:i=!1)}return this.run(()=>{s?(this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0}))),this.setSelectedShapes([])):i?this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!1}))):this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0})))}),this}sendToBack(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,e1.B)(this,"toBack",t,{considerAllShapes:!0});return i&&this.updateShapes(i),this}sendBackward(e,t={}){let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,e1.B)(this,"backward",i,t);return s&&this.updateShapes(s),this}bringForward(e,t={}){let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,e1.B)(this,"forward",i,t);return s&&this.updateShapes(s),this}bringToFront(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,e1.B)(this,"toFront",t);return i&&this.updateShapes(i),this}collectShapesViaArrowBindings(e){let{initialShapes:t,resultShapes:i,resultBounds:s,bindings:r,visited:n}=e;for(let a of r)for(let r of[a.fromId,a.toId])if(!n.has(r)){let a=t.find(e=>e.id===r);if(a&&!n.has(a.id)){n.add(a.id);let t=this.getShapePageBounds(a);if(!t)continue;i.push(a),s.push(t),this.collectShapesViaArrowBindings({...e,bindings:this.getBindingsInvolvingShape(a,"arrow")})}}}flipShapes(e,t){if(this.getIsReadonly())return this;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,ev.oA)(i.map(e=>this.getShape(e)));for(let e of s)if(this.isShapeOfType(e,"group")){let t=(0,ev.oA)(this.getSortedChildIdsForParent(e.id).map(e=>this.getShape(e)));s.push(...t)}let r=[],n=[];for(let e of s){let t=this.getShapeUtil(e);if(!t.canBeLaidOut(e,{type:"flip",shapes:s}))continue;let i=this.getShapePageBounds(e),a=this.getShapeGeometry(e).bounds,h=this.getShapePageTransform(e.id);i&&a&&h&&(r.push({shape:e,localBounds:a,pageTransform:h,isAspectRatioLocked:t.isAspectRatioLocked(e)}),n.push(i))}if(!r.length)return this;let a=eD.xu.Common(n).center;return this.run(()=>{for(let{shape:e,localBounds:i,pageTransform:s,isAspectRatioLocked:n}of r)this.resizeShape(e.id,{x:"horizontal"===t?-1:1,y:"vertical"===t?-1:1},{initialBounds:i,initialPageTransform:s,initialShape:e,isAspectRatioLocked:n,mode:"scale_shape",scaleOrigin:a,scaleAxisRotation:0})}),this}stackShapes(e,t,i){let s,r,n,a;let h=i??this.options.adjacentShapeMargin,o="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly())return this;let l=(0,ev.oA)(o.map(e=>this.getShape(e))),p=[],g=[],d=new Set;for(let e of l){if(d.has(e.id))continue;d.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"stack",shapes:l}))continue;let i=[e],s=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:l,resultShapes:i,resultBounds:s,visited:d});let r=eD.xu.Common(s);r&&(p.push({shapes:i,pageBounds:r}),g.push(r))}let u=p.length;if(0===h&&u<3||u<2)return this;"horizontal"===t?(s="x",r="minX",n="maxX",a="width"):(s="y",r="minY",n="maxY",a="height");let c=0;if(0===h){let e={};p.sort((e,t)=>e.pageBounds[r]-t.pageBounds[r]);for(let t=0;t<u-1;t++){let i=p[t],s=p[t+1].pageBounds[r]-i.pageBounds[n];e[s]||(e[s]=0),e[s]++}let t=1;for(let[i,s]of Object.entries(e))s>t&&(t=s,c=parseFloat(i));if(1===t){let t=0;for(let[i,s]of Object.entries(e))c+=parseFloat(i)*s,t+=s;c/=t}}else c=h;let S=[],f=p[0].pageBounds[n];for(let e=1;e<p.length;e++){let{shapes:t,pageBounds:i}=p[e],r=new eZ.B;for(let e of(r[s]=f+c-i[s],t)){let t=r.clone(),i=this.getShapeParent(e);if(i){let e=this.getShapePageTransform(i);e&&t.rot(-e.rotation())}t.add(e),S.push(this.getChangesToTranslateShape(e,t))}f+=i[a]+c}return this.updateShapes(S),this}packShapes(e,t){let i,s;if(this.getIsReadonly())return this;let r=t??this.options.adjacentShapeMargin,n="string"==typeof e[0]?e:e.map(e=>e.id),a=(0,ev.oA)(n.map(e=>this.getShape(e))),h=[],o=[],l=new Set;for(let e of a){if(l.has(e.id))continue;l.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"pack",shapes:a}))continue;let i=[e],s=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:a,resultShapes:i,resultBounds:s,visited:l});let r=eD.xu.Common(s);r&&(h.push({shapes:i,pageBounds:r,nextPageBounds:r.clone()}),o.push(r))}if(h.length<2)return this;let p=0;for(let{pageBounds:e}of h)p+=e.width*e.height;let g=eD.xu.Common(o),d=g.width;h.sort((e,t)=>e.pageBounds.width-t.pageBounds.width).sort((e,t)=>e.pageBounds.height-t.pageBounds.height);let u=Math.max(Math.ceil(Math.sqrt(p/.95)),d),c=[new eD.xu(g.x,g.y,u,1/0)],S=0,f=0;for(let{nextPageBounds:e}of h)for(let t=c.length-1;t>=0;t--)if(i=c[t],!(e.width>i.width)&&!(e.height>i.height)){e.x=i.x,e.y=i.y,f=Math.max(f,e.maxY),S=Math.max(S,e.maxX),e.width===i.width&&e.height===i.height?(s=c.pop(),t<c.length&&(c[t]=s)):e.height===i.height?(i.x+=e.width+r,i.width-=e.width+r):(e.width===i.width||c.push(new eD.xu(i.x+(e.width+r),i.y,i.width-(e.width+r),e.height)),i.y+=e.height+r,i.height-=e.height+r);break}let m=eD.xu.Common(h.map(e=>e.nextPageBounds)),y=eZ.B.Sub(g.center,m.center),I=[];for(let{shapes:e,pageBounds:t,nextPageBounds:i}of h){let s=eZ.B.Sub(i.point,t.point).add(y);for(let t of e){let e=s.clone();if(this.getShapeParent(t)){let i=this.getShapeParentTransform(t);i&&e.rot(-i.rotation())}e.add(t),I.push(this.getChangesToTranslateShape(t,e))}}return I.length&&this.updateShapes(I),this}alignShapes(e,t){if(this.getIsReadonly())return this;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,ev.oA)(i.map(e=>this.getShape(e))),r=[],n=[],a=new Set;for(let e of s){if(a.has(e.id))continue;a.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"align",shapes:s}))continue;let i=[e],h=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:s,resultShapes:i,resultBounds:h,visited:a});let o=eD.xu.Common(h);o&&(r.push({shapes:i,pageBounds:o}),n.push(o))}if(r.length<2)return this;let h=eD.xu.Common(n),o=[];return r.forEach(({shapes:e,pageBounds:i})=>{let s=new eZ.B;switch(t){case"top":s.y=h.minY-i.minY;break;case"center-vertical":s.y=h.midY-i.minY-i.height/2;break;case"bottom":s.y=h.maxY-i.minY-i.height;break;case"left":s.x=h.minX-i.minX;break;case"center-horizontal":s.x=h.midX-i.minX-i.width/2;break;case"right":s.x=h.maxX-i.minX-i.width}for(let t of e){let e=s.clone(),i=this.getShapeParent(t);if(i){let t=this.getShapePageTransform(i);t&&e.rot(-t.rotation())}e.add(t),o.push(this.getChangesToTranslateShape(t,e))}}),this.updateShapes(o),this}distributeShapes(e,t){let i,s,r,n;if(this.getIsReadonly())return this;let a="string"==typeof e[0]?e:e.map(e=>e.id),h=(0,ev.oA)(a.map(e=>this.getShape(e))),o=[],l=[],p=new Set;for(let e of h){if(p.has(e.id))continue;p.add(e.id);let t=this.getShapePageBounds(e);if(!t||!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"distribute",shapes:h}))continue;let i=[e],s=[t];this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:h,resultShapes:i,resultBounds:s,visited:p});let r=eD.xu.Common(s);r&&(o.push({shapes:i,pageBounds:r}),l.push(r))}if(o.length<3)return this;"horizontal"===t?(i="x",s="minX",r="maxX",n="width"):(i="y",s="minY",r="maxY",n="height");let g=[],d=o.sort((e,t)=>e.pageBounds[s]-t.pageBounds[s])[0],u=o.sort((e,t)=>t.pageBounds[r]-e.pageBounds[r])[0];if(d===u){let e=new Set(d.shapes.map(e=>e.id));return this.distributeShapes(a.filter(t=>!e.has(t)),t)}let c=o.filter(e=>e!==d&&e!==u).sort((e,t)=>e.pageBounds[s]===t.pageBounds[s]?e.shapes[0].id<t.shapes[0].id?-1:1:e.pageBounds[s]-t.pageBounds[s]),S=d.pageBounds[r],f=(u.pageBounds[s]-S-c.reduce((e,t)=>e+t.pageBounds[n],0))/(c.length+1);for(let e=S+f,t=0;t<c.length;t++){let{shapes:s,pageBounds:a}=c[t],h=new eZ.B;for(let t of(h[i]=e-a[i],e+a[n]>u.pageBounds[r]-1&&(h[i]=u.pageBounds[r]-a[r]-1),s)){let e=h.clone(),i=this.getShapeParent(t);if(i){let t=this.getShapePageTransform(i);t&&e.rot(-t.rotation())}e.add(t),g.push(this.getChangesToTranslateShape(t,e))}e+=a[n]+f}return this.updateShapes(g),this}stretchShapes(e,t){let i,s,r;let n="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getIsReadonly())return this;let a=(0,ev.oA)(n.map(e=>this.getShape(e))).filter(e=>this.getShapePageTransform(e)?.rotation()%(eX.PI/2)==0),h=[],o=[],l=new Set;for(let e of a){if(l.has(e.id))continue;l.add(e.id);let t=this.getShapePageBounds(e);if(!t)continue;let i=[e],s=[t];if(!this.getShapeUtil(e).canBeLaidOut?.(e,{type:"stretch",shapes:a}))continue;this.collectShapesViaArrowBindings({bindings:this.getBindingsToShape(e.id,"arrow"),initialShapes:a,resultShapes:i,resultBounds:s,visited:l});let r=eD.xu.Common(s);r&&(h.push({shapes:i,pageBounds:r}),o.push(r))}if(h.length<2)return this;let p=eD.xu.Common(o);return"horizontal"===t?(i="x",s="minX",r="width"):(i="y",s="minY",r="height"),this.run(()=>{h.forEach(({shapes:e,pageBounds:t})=>{let n=new eZ.B;n[i]=p[s]-t[s];let a=t.center.clone();a[i]=p[s];let h=new eZ.B(1,1);for(let s of(h[i]=p[r]/t[r],e)){let e=n.clone(),t=this.getShapeParentTransform(s);t&&n.rot(-t.rotation()),e.add(s);let i=this.getChangesToTranslateShape(s,e);this.updateShape(i),this.resizeShape(s.id,h,{initialBounds:this.getShapeGeometry(s).bounds,scaleOrigin:a,isAspectRatioLocked:this.getShapeUtil(s).isAspectRatioLocked(s),scaleAxisRotation:0})}})}),this}resizeShape(e,t,i={}){let s="string"==typeof e?e:e.id;if(this.getIsReadonly())return this;Number.isFinite(t.x)||(t=new eZ.B(1,t.y)),Number.isFinite(t.y)||(t=new eZ.B(t.x,1));let r=i.initialShape??this.getShape(s);if(!r)return this;let n=i.scaleOrigin??this.getShapePageBounds(s)?.center;if(!n)return this;let a=i.initialPageTransform?eH._.Cast(i.initialPageTransform):this.getShapePageTransform(s);if(!a)return this;let h=a.rotation();if(null==h)return this;let o=i.scaleAxisRotation??h,l=i.initialBounds??this.getShapeGeometry(s).bounds;if(!l)return this;let p=i.isAspectRatioLocked??this.getShapeUtil(r).isAspectRatioLocked(r);if(!(0,eX._G)(h,o))return this._resizeUnalignedShape(s,t,{...i,initialBounds:l,scaleOrigin:n,scaleAxisRotation:o,initialPageTransform:a,isAspectRatioLocked:p,initialShape:r});let g=this.getShapeUtil(r);p&&(t=Math.abs(t.x)>Math.abs(t.y)?new eZ.B(t.x,Math.sign(t.y)*Math.abs(t.x)):new eZ.B(Math.sign(t.x)*Math.abs(t.y),t.y));let d=!1;if(g.onResize&&g.canResize(r)){let e=this._scalePagePoint(eH._.applyToPoint(a,new eZ.B(0,0)),n,t,o),p=this.getPointInParentSpace(r.id,e),u=new eZ.B(t.x,t.y),c=(0,eX.C2)((h-o)%Math.PI,0);u.x=c?t.x:t.y,u.y=c?t.y:t.x;let S=eH._.applyToPoint(a,new eZ.B),{x:f,y:m}=this.getPointInParentSpace(r.id,S),y=r;i.skipStartAndEndCallbacks||(y=tk(r,g.onResizeStart?.(r)??void 0));let I=g.onResize({...r,x:f,y:m},{newPoint:p,handle:i.dragHandle??"bottom_right",mode:i.mode??"scale_shape",scaleX:u.x,scaleY:u.y,initialBounds:l,initialShape:r});I&&(d=!0),y=tk(y,{id:s,type:r.type,x:p.x,y:p.y,...I}),i.skipStartAndEndCallbacks||(y=tk(y,g.onResizeEnd?.(r,y)??void 0)),this.updateShapes([y])}if(!d){let e=eH._.applyToPoint(a,l.center),i=this._scalePagePoint(e,n,t,o),h=this.getPointInParentSpace(r.id,e),p=this.getPointInParentSpace(r.id,i),g=eZ.B.Sub(p,h);this.updateShapes([{id:s,type:r.type,x:r.x+g.x,y:r.y+g.y}])}return this}_scalePagePoint(e,t,i,s){let r=eZ.B.RotWith(e,t,-s).sub(t),n=eZ.B.MulV(r,i);return eZ.B.Add(n,t).rotWith(t,s)}_resizeUnalignedShape(e,t,i){let{type:s}=i.initialShape,r=new eZ.B(t.x,t.y);if(Math.abs(t.x)>Math.abs(t.y)?r.x=Math.sign(t.x)*Math.abs(t.y):r.y=Math.sign(t.y)*Math.abs(t.x),this.resizeShape(e,r,{initialShape:i.initialShape,initialBounds:i.initialBounds,isAspectRatioLocked:i.isAspectRatioLocked}),Math.sign(t.x)*Math.sign(t.y)<0){let{rotation:t}=eH._.Decompose(i.initialPageTransform);t-=2*t,this.updateShapes([{id:e,type:s,rotation:t}])}let n=eH._.applyToPoint(i.initialPageTransform,i.initialBounds.center),a=this._scalePagePoint(n,i.scaleOrigin,t,i.scaleAxisRotation),h=this.getShapePageBounds(e),o=this.getShapePageTransform(e),l=h.center,p=o.point();if(!l||!p)return this;let g=eZ.B.Sub(a,l),d=eZ.B.Add(p,g),{x:u,y:c}=this.getPointInParentSpace(e,d);return this.updateShapes([{id:e,type:s,x:u,y:c}]),this}getInitialMetaForShape(e){return{}}canCreateShape(e){return this.canCreateShapes([e])}canCreateShapes(e){return e.length+this.getCurrentPageShapeIds().size<=this.options.maxShapesPerPage}createShape(e){return this.createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");if(this.getIsReadonly()||e.length<=0)return this;let t=this.getCurrentPageShapeIds();if(e.length+t.size>this.options.maxShapesPerPage)return tv(this),this;let i=this.getFocusedGroupId();return this.run(()=>{let t=this.getCurrentPageShapesSorted(),s=e.map(s=>{if(s.id||(s={id:(0,eb.F1)(),...s}),!s.parentId||!(this.store.has(s.parentId)||e.some(e=>e.id===s.parentId))){let e=this.getFocusedGroupId();for(let i=t.length-1;i>=0;i--){let r=t[i];if(this.getShapeUtil(r).canReceiveNewChildrenOfType(r,s.type)&&!this.isShapeHidden(r)&&this.isPointInShape(r,{x:s.x??0,y:s.y??0},{margin:0,hitInside:!0})){e=r.id;break}}let r=s.parentId;if(e===s.id&&(e=i),e!==r&&((s={...s}).parentId=e,(0,eb.YT)(e))){let t=this.getPointInShapeSpace(this.getShape(e),{x:s.x??0,y:s.y??0});s.x=t.x,s.y=t.y,s.rotation=-this.getShapePageTransform(e).rotation()+(s.rotation??0)}}return s}),r=new Map,n=[],{opacityForNextShape:a}=this.getInstanceState();for(let e of s){let t=this.getShapeUtil(e),s=e.index;if(!s){let t=e.parentId??i;r.has(t)||r.set(t,this.getHighestIndexForParent(t)),s=r.get(t),r.set(t,(0,ev._L)(s))}let h=t.getDefaultProps();for(let[t,i]of this.styleProps[e.type])h[i]=this.getStyleForNextShape(t);let o=this.store.schema.types.shape.create({...e,index:s,opacity:e.opacity??a,parentId:e.parentId??i,props:"props"in e?{...h,...e.props}:h});if(void 0===o.index)throw Error("no index!");let l=this.getShapeUtil(o).onBeforeCreate?.(o);l&&(o=l),n.push(o)}n.forEach(e=>{e.meta={...this.getInitialMetaForShape(e),...e.meta}}),this.emit("created-shapes",n),this.emit("edit"),this.store.put(n)}),this}animateShape(e,t={animation:eE.Xy}){return this.animateShapes([e],t)}animateShapes(e,t={animation:eE.Xy}){let i,s,r;if(!t.animation)return this;let{duration:n=500,easing:a=eG.L.linear}=t.animation,h=(0,ev.EL)(),o=n,l=[];for(let t=0,i=e.length;t<i;t++){if(!(s=e[t]))continue;let i=this.getShape(s.id);i&&(r={start:(0,ev.v4)(i),end:tk((0,ev.v4)(i),s)},l.push(r),this.animatingShapes.set(i.id,h))}let p=t=>{if((o-=t)<0){let{animatingShapes:t}=this,i=e.filter(e=>e&&t.get(e.id)===h);i.length&&this.updateShapes(i),this.off("tick",p);return}i=a(1-o/n);let{animatingShapes:s}=this,r=[];for(let e=0,t=l.length;e<t;e++){let{start:t,end:n}=l[e];s.get(t.id)===h&&r.push({...n,x:t.x+(n.x-t.x)*i,y:t.y+(n.y-t.y)*i,opacity:t.opacity+(n.opacity-t.opacity)*i,rotation:t.rotation+(n.rotation-t.rotation)*i,props:this.getShapeUtil(n).getInterpolatedProps?.(t,n,i)??n.props})}this._updateShapes(r)};return this.on("tick",p),this}groupShapes(e,t={}){let{groupId:i=(0,eb.F1)(),select:s=!0}=t;if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getIsReadonly())return this;let r="string"==typeof e[0]?e:e.map(e=>e.id);if(r.length<=1)return this;let n=(0,ev.oA)((this._shouldIgnoreShapeLock?r:this._getUnlockedShapeIds(r)).map(e=>this.getShape(e))),a=n.sort(ev.hl).map(e=>e.id),{x:h,y:o}=eD.xu.Common((0,ev.oA)(n.map(e=>this.getShapePageBounds(e)))).point,l=this.findCommonAncestor(n)??this.getCurrentPageId();if("select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let p=n.filter(e=>e.parentId===l).sort(ev.hl),g=p[p.length-1]?.index;return this.run(()=>{this.createShapes([{id:i,type:"group",parentId:l,index:g,x:h,y:o,opacity:1,props:{}}]),this.reparentShapes(a,i),s&&this.select(i)}),this}ungroupShapes(e,t={}){if(this.getIsReadonly())return this;let{select:i=!0}=t,s="string"==typeof e[0]?e:e.map(e=>e.id),r=(0,ev.oA)((this._shouldIgnoreShapeLock?s:this._getUnlockedShapeIds(s)).map(e=>this.getShape(e)));if(0===r.length||"select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let n=new Set,a=[];return r.forEach(e=>{this.isShapeOfType(e,"group")?a.push(e):n.add(e.id)}),0===a.length||this.run(()=>{let e;for(let t=0,i=a.length;t<i;t++){e=a[t];let i=this.getSortedChildIdsForParent(e.id);for(let e=0,t=i.length;e<t;e++)n.add(i[e]);this.reparentShapes(i,e.parentId,e.index)}this.deleteShapes(a.map(e=>e.id)),i&&this.select(...n)}),this}updateShape(e){return this.updateShapes([e]),this}updateShapes(e){let t=Array(e.length);for(let i=0,s=e.length;i<s;i++){let s=e[i];if(!s)continue;let r=this.getShape(s.id);if(r){if(!this._shouldIgnoreShapeLock){if(r.isLocked){if(!(Object.hasOwn(s,"isLocked")&&!s.isLocked))continue}else if(this.isShapeOrAncestorLocked(r))continue}this.animatingShapes.delete(s.id),t.push(s)}}return this._updateShapes(t),this}_updateShapes(e){this.getIsReadonly()||this.run(()=>{let t,i;let s=[];for(let r=0,n=e.length;r<n;r++){let n=e[r];n&&(t=this.getShape(n.id))&&(i=tk(t,n))!==t&&(i=this.getShapeUtil(t).onBeforeUpdate?.(t,i)??i,s.push(i))}this.emit("edited-shapes",s),this.emit("edit"),this.store.put(s)})}_getUnlockedShapeIds(e){return e.filter(e=>!this.getShape(e)?.isLocked)}deleteShapes(e){if(this.getIsReadonly())return this;if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this._shouldIgnoreShapeLock?t:this._getUnlockedShapeIds(t);if(0===i.length)return this;let s=new Set(i);for(let e of i)this.visitDescendants(e,e=>{s.add(e)});return this.emit("deleted-shapes",[...s]),this.emit("edit"),this.run(()=>this.store.remove([...s]))}deleteShape(e){return this.deleteShapes(["string"==typeof e?e:e.id]),this}_extractSharedStyles(e,t){if(this.isShapeOfType(e,"group")){let i=this._parentIdsToChildIds.get()[e.id];if(i)for(let e=0,s=i.length;e<s;e++)this._extractSharedStyles(this.getShape(i[e]),t)}else for(let[i,s]of this.styleProps[e.type])t.applyValue(i,(0,ev.eg)(e.props,s))}_getSelectionSharedStyles(){let e=this.getSelectedShapes(),t=new eq.o;for(let i of e)this._extractSharedStyles(i,t);return t}getStyleForNextShape(e){let t=this.getInstanceState().stylesForNextShape[e.id];return void 0===t?e.defaultValue:t}getShapeStyleIfExists(e,t){let i=this.styleProps[e.type].get(t);if(void 0!==i)return(0,ev.eg)(e.props,i)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();let e=this.root.getCurrent(),t=new eq.o;if(!e)return t;if(e.shapeType){if("frame"!==e.shapeType||this.getShapeUtil("frame").options.showColors)for(let i of this.styleProps[e.shapeType].keys())t.applyValue(i,this.getStyleForNextShape(i));else for(let i of this.styleProps[e.shapeType].keys())"tldraw:color"!==i.id&&t.applyValue(i,this.getStyleForNextShape(i))}return t}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){let e=[],t=i=>{let s=this.getShape(i);if(s){if(this.isShapeOfType(s,"group"))for(let e of this.getSortedChildIdsForParent(s.id))t(e);else e.push(s)}};for(let e of this.getSelectedShapeIds())t(e);let i=null;for(let t of e)if(null===i)i=t.opacity;else if(i!==t.opacity)return{type:"mixed"};if(null!==i)return{type:"shared",value:i}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,t){return this.updateInstanceState({opacityForNextShape:e},t),this}setOpacityForSelectedShapes(e){let t=this.getSelectedShapes();if(t.length>0){let i=[],s=e=>{if(this.isShapeOfType(e,"group"))for(let t of this.getSortedChildIdsForParent(e))s(this.getShape(t));else i.push(e)};for(let e of t)s(e);this.updateShapes(i.map(t=>({id:t.id,type:t.type,opacity:e})))}return this}setStyleForNextShapes(e,t,i){let s=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...s,[e.id]:t}},i),this}setStyleForSelectedShapes(e,t){let i=this.getSelectedShapes();if(i.length>0){let s=[],r=i=>{if(this.isShapeOfType(i,"group"))for(let e of this.getSortedChildIdsForParent(i.id))r(this.getShape(e));else{let r=this.getShapeUtil(i),n=this.styleProps[i.type].get(e);if(n){let e={id:i.id,type:i.type,props:{[n]:t}};s.push({util:r,originalShape:i,updatePartial:e})}}};for(let e of i)r(e);this.updateShapes(s.map(({updatePartial:e})=>e))}return this}registerExternalAssetHandler(e,t){return this.externalAssetContentHandlers[e]=t,this}createTemporaryAssetPreview(e,t){if(this.temporaryAssetPreview.has(e))return this.temporaryAssetPreview.get(e);let i=URL.createObjectURL(t);return this.temporaryAssetPreview.set(e,i),setTimeout(()=>{this.temporaryAssetPreview.delete(e),URL.revokeObjectURL(i)},this.options.temporaryAssetPreviewLifetimeMs),i}getTemporaryAssetPreview(e){return this.temporaryAssetPreview.get(e)}async getAssetForExternalContent(e){return await this.externalAssetContentHandlers[e.type]?.(e)}hasExternalAssetHandler(e){return!!this.externalAssetContentHandlers[e]}registerExternalContentHandler(e,t){return this.externalContentHandlers[e]=t,this}async putExternalContent(e){return this.externalContentHandlers[e.type]?.(e)}async replaceExternalContent(e){return this.externalContentHandlers[e.type]?.(e)}getContentFromCurrentPage(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(!t||0===t.length)return;let i=this.getShapeAndDescendantIds(t);return tF(this,i,e=>{let t=[];for(let i of e){let e=this.getBinding(i);e&&t.push(e)}let s=[],r=[];for(let e of i){let t=this.getShape(e);if(t){if(i.has(t.parentId))r.push(t);else{let e=this.getShapePageTransform(t.id),i=e.point();r.push({...t,x:i.x,y:i.y,rotation:e.rotation(),parentId:this.getCurrentPageId()}),s.push(t.id)}}}let n=[],a=new Set;for(let e of r){if(!("assetId"in e.props))continue;let t=e.props.assetId;if(!t||a.has(t))continue;a.add(t);let i=this.getAsset(t);i&&n.push(i)}return{schema:this.store.schema.serialize(),shapes:r,rootShapeIds:s,bindings:t,assets:n}})}async resolveAssetsInContent(e){if(!e)return;let t=[];return await Promise.allSettled(e.assets.map(async e=>{if("image"!==e.type&&"video"!==e.type||e.props.src?.startsWith("data:image")||e.props.src?.startsWith("data:video")||e.props.src?.startsWith("http"))t.push(e);else{let i=(0,ev.v4)(e),s=await this.store.props.assets.resolve(e,{screenScale:1,steppedScreenScale:1,dpr:1,networkEffectiveType:null,shouldResolveToOriginal:!0});i.props.src=await ev.P6.blobToDataUrl(await (0,ev.he)(s).then(e=>e.blob())),t.push(i)}})),e.assets=t,e}putContentOntoCurrentPage(e,t={}){if(this.getIsReadonly())return this;if(!e.schema)throw Error("Could not put content:\ncontent is missing a schema.");let{select:i=!1,preserveIds:s=!1,preservePosition:r=!1}=t,{point:n}=t,a=this.getCurrentPageId(),{rootShapeIds:h}=e,o=[],l=[],p=[],g={store:{...Object.fromEntries(e.assets.map(e=>[e.id,e])),...Object.fromEntries(e.shapes.map(e=>[e.id,e])),...Object.fromEntries(e.bindings?.map(e=>[e.id,e])??[])},schema:e.schema},d=this.store.schema.migrateStoreSnapshot(g);if("error"===d.type)throw Error("Could not put content: could not migrate content");for(let e of Object.values(d.value))switch(e.typeName){case"asset":o.push(e);break;case"shape":l.push(e);break;case"binding":p.push(e)}let u=new Map(s?l.map(e=>[e.id,e.id]):l.map(e=>[e.id,(0,eb.F1)()])),c=new Map(s?p.map(e=>[e.id,e.id]):p.map(e=>[e.id,(0,eb.vI)()])),S=this.getCurrentPageId(),f=1/0,m=[];for(let e of this.getSelectedShapes()){if(0===f)break;let t=this.isShapeOfType(e,"frame"),i=this.getShapeAncestors(e);t&&i.push(e);let s=t?i.length+1:i.length;if(s<f)f=s,m=i,S=t?e.id:e.parentId;else if(s===f){if(m.length!==i.length)throw Error(`Ancestors: ${m.length} !== ${i.length}`);if(0===m.length){S=a;break}S=a;for(let e=0;e<m.length&&i[e]===m[e];e++)S=i[e].id}}let y=!1;if(!(0,eb.r5)(S)){let e=this.getShape(S);if(e){if(this.getViewportPageBounds().includes(this.getShapePageBounds(e))){if(1===h.length){let t=l.find(e=>e.id===h[0]);this.isShapeOfType(e,"frame")&&this.isShapeOfType(t,"frame")&&t.props.w===e?.props.w&&t.props.h===e?.props.h&&(y=!0)}}else S=a}else S=a}y||(y=u.has(S)),y&&(S=this.getShape(S).parentId);let I=this.getHighestIndexForParent(S),P=[],C=l.map(e=>{let t=u.get(e.id),i={...e,id:t};return h.includes(e.id)&&(i.parentId=a,P.push(i)),u.has(i.parentId)?i.parentId=u.get(e.parentId):(h.push(i.id),i.index=I,I=(0,ev._L)(I)),i});if(C.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage)return tv(this),this;let w=p.map(e=>({...e,id:(0,ev.kP)(c.get(e.id)),fromId:(0,ev.kP)(u.get(e.fromId)),toId:(0,ev.kP)(u.get(e.toId))})),_=[],B=[];for(let e of o)this.store.has(e.id)||(("image"===e.type&&e.props.src?.startsWith("data:image")||"video"===e.type&&e.props.src?.startsWith("data:video"))&&(B.push((0,ev.v4)(e)),e.props.src=null),_.push(e));return Promise.allSettled(B.map(async e=>{let t=await (0,eQ.B)(e.props.src,e.props.name,e.props.mimeType??"image/png"),i=await this.getAssetForExternalContent({type:"file",file:t,assetId:e.id});if(!i){this.deleteAssets([e.id]);return}this.updateAssets([{...i,id:e.id}])})),this.run(()=>{_.length>0&&this.createAssets(_),this.createShapes(C),this.createBindings(w),i&&this.select(...P.map(e=>e.id)),S!==a&&this.reparentShapes(P.map(e=>e.id),S);let e=C.map(e=>this.getShape(e.id)),t=eD.xu.Common(e.map(e=>this.getShapePageBounds(e)));if(void 0===n){if((0,eb.r5)(S)){let e=this.getViewportPageBounds();n=r||e.includes(eD.xu.From(t))?t.center:e.center}else{let e=this.getShape(S);n=eH._.applyToPoint(this.getShapePageTransform(e),this.getShapeGeometry(e).bounds.center)}}if(1===P.length){let e=P[0];if(this.isShapeOfType(e,"frame"))for(;this.getShapesAtPoint(n).some(t=>this.isShapeOfType(t,"frame")&&t.props.w===e.props.w&&t.props.h===e.props.h);)n.x+=t.w+16}let s=eD.xu.Common((0,ev.oA)(P.map(({id:e})=>this.getShapePageBounds(e)))).center,h=eZ.B.Sub(n,s);this.updateShapes(P.map(({id:e})=>{let t=this.getShape(e),i=this.getShapeParentTransform(e).decompose().rotation,s=eZ.B.Rot(h,-i);return{id:t.id,type:t.type,x:t.x+s.x,y:t.y+s.y}}))}),this}async getSvgElement(e,t={}){let i=0===e.length?this.getCurrentPageShapeIdsSorted():"string"==typeof e[0]?e:e.map(e=>e.id);if(0!==i.length)return(0,eU.$)(this,i,t)}async getSvgString(e,t={}){let i=await this.getSvgElement(e,t);if(i)return{svg:new XMLSerializer().serializeToString(i.svg),width:i.width,height:i.height}}async getSvg(e,t={}){let i=await this.getSvgElement(e,t);if(i)return i.svg}async toImage(e,t={}){let i={format:"png",scale:1,pixelRatio:"svg"===t.format?void 0:2,...t},s=await this.getSvgString(e,i);if(!s)throw Error("Could not create SVG");switch(i.format){case"svg":return{blob:new Blob([s.svg],{type:"image/svg+xml"}),width:s.width,height:s.height};case"jpeg":case"png":case"webp":{let e=await (0,eR.u)(s.svg,{type:i.format,quality:i.quality,pixelRatio:i.pixelRatio,width:s.width,height:s.height});if(!e)throw Error("Could not construct image.");return{blob:e,width:s.width,height:s.height}}default:(0,ev.iP)(i.format)}}_updateInputsFromEvent(e){let{pointerVelocity:t,previousScreenPoint:i,previousPagePoint:s,currentScreenPoint:r,currentPagePoint:n,originScreenPoint:a,originPagePoint:h}=this.inputs,{screenBounds:o}=this.store.unsafeGetWithoutCapture(eb.PQ),{x:l,y:p,z:g}=(0,eB.dy)(()=>this.getCamera()),d=e.point.x-o.x,u=e.point.y-o.y,c=e.point.z??.5;i.setTo(r),s.setTo(n),r.set(d,u);let S=d/g-l,f=u/g-p;isFinite(S)&&isFinite(f)&&n.set(S,f,c),this.inputs.isPen="pointer"===e.type&&e.isPen,("pointer_down"===e.name||this.inputs.isPinching)&&(t.set(0,0),a.setTo(r),h.setTo(n)),this.run(()=>{this.store.put([{id:eb.LV,typeName:"pointer",x:n.x,y:n.y,lastActivityTimestamp:"pointer"===e.type&&e.pointerId===eE.CK.CAMERA_MOVE?this.store.unsafeGetWithoutCapture(eb.LV)?.lastActivityTimestamp??this._tickManager.now:this._tickManager.now,meta:{}}])},{history:"ignore"})}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}focus({focusContainer:e=!0}={}){return this.getIsFocused()||(e&&this.focusManager.focus(),this.updateInstanceState({isFocused:!0})),this}blur({blurContainer:e=!0}={}){return this.getIsFocused()&&(e?this.focusManager.blur():this.complete(),this.updateInstanceState({isFocused:!1})),this}getIsFocused(){return this.getInstanceState().isFocused}getIsReadonly(){return this.getInstanceState().isReadonly}getSnapshot(){return(0,eF.v)(this.store)}loadSnapshot(e,t){return(0,eF.w)(this.store,e,t),this}_zoomToFitPageContentAt100Percent(){let e=this.getCurrentPageBounds();e&&this.zoomToBounds(e,{immediate:!0,targetZoom:this.getBaseZoom()})}_navigateToDeepLink(e){this.run(()=>{switch(e.type){case"page":{let t=this.getPage(e.pageId);t&&this.setCurrentPage(t),this._zoomToFitPageContentAt100Percent();return}case"shapes":{let t=(0,ev.oA)(e.shapeIds.map(e=>this.getShape(e))),i={};for(let e of t){let t=this.getAncestorPageId(e);t&&(i[t]??=[],i[t].push(e))}let[s,r]=Object.entries(i).sort(([e,t],[i,s])=>s.length-t.length)[0]??["",[]];if(s&&r.length){this.setCurrentPage(s);let e=eD.xu.Common(r.map(e=>this.getShapePageBounds(e)));this.zoomToBounds(e,{immediate:!0,targetZoom:this.getBaseZoom()})}else this._zoomToFitPageContentAt100Percent();return}case"viewport":if(e.pageId){if(!this.getPage(e.pageId)){this._zoomToFitPageContentAt100Percent();return}this.setCurrentPage(e.pageId)}this.zoomToBounds(e.bounds,{immediate:!0,inset:0});return;default:(0,ev.iP)(e)}})}navigateToDeepLink(e){if(e&&"type"in e)return this._navigateToDeepLink(e),this;let t=new URL(e?.url??window.location.href).searchParams.get(e?.param??"d");if(!t)return this._zoomToFitPageContentAt100Percent(),this;try{this._navigateToDeepLink((0,e$.Y)(t))}catch(e){console.warn(e),this._zoomToFitPageContentAt100Percent()}return this}createDeepLink(e){let t=new URL(e?.url??window.location.href);return t.searchParams.set(e?.param??"d",(0,e$.y)(e?.to??{type:"viewport",pageId:1===this.options.maxPages?void 0:this.getCurrentPageId(),bounds:this.getViewportPageBounds()})),t}registerDeepLinkListener(e){if(e?.getUrl&&!e?.onChange)throw Error("[tldraw:urlStateSync] If you specify getUrl, you must also specify the onChange callback.");let t=(0,eB.Fl)("url with state",()=>{let t=e?.getUrl?.(this)??window.location.href;return this.createDeepLink({param:e?.param,url:t,to:e?.getTarget?.(this)}).toString()}),i=e?.onChange??(()=>{let t=this.createDeepLink({param:e?.param,to:e?.getTarget?.(this)});window.history.replaceState({},document.title,t.toString())}),s=(0,ev.Ds)(e=>e(),e?.debounceMs??500),r=(0,eB.Ym)("update url on state change",()=>i(new URL(t.get()),this),{scheduleEffect:s});return()=>{r(),s.cancel()}}cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_setShiftKeyTimeout(){this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"ShiftLeft"})}_setAltKeyTimeout(){this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"AltLeft"})}_setCtrlKeyTimeout(){this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"ControlLeft"})}_setMetaKeyTimeout(){this.inputs.metaKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Meta",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,metaKey:this.inputs.metaKey,accelKey:(0,e0.q)(this.inputs),code:"MetaLeft"})}dispatch(e){return this._pendingEventsForNextTick.push(e),"pointer"===e.type&&"pointer_move"===e.name||"wheel"===e.type||"pinch"===e.type||this._flushEventsForTick(0),this}_flushEventsForTick(e){this.run(()=>{if(this._pendingEventsForNextTick.length>0){let e=[...this._pendingEventsForNextTick];for(let t of(this._pendingEventsForNextTick.length=0,e))this._flushEventForTick(t)}e>0&&this.root.handleEvent({type:"misc",name:"tick",elapsed:e}),this.scribbles.tick(e)})}_flushEventForTick(e){if(this.getCrashingError())return this;this.emit("before-event",e);let{inputs:t}=this,{type:i}=e;if("misc"===e.type){("cancel"===e.name||"complete"===e.name)&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.inputs.isSpacebarPanning=!1,this.setCursor({type:this._prevCursor,rotation:0}))),this.root.handleEvent(e);return}e.shiftKey?(clearTimeout(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,t.shiftKey=!0):!e.shiftKey&&t.shiftKey&&-1===this._shiftKeyTimeout&&(this._shiftKeyTimeout=this.timers.setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearTimeout(this._altKeyTimeout),this._altKeyTimeout=-1,t.altKey=!0):!e.altKey&&t.altKey&&-1===this._altKeyTimeout&&(this._altKeyTimeout=this.timers.setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearTimeout(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,t.ctrlKey=!0):!e.ctrlKey&&t.ctrlKey&&-1===this._ctrlKeyTimeout&&(this._ctrlKeyTimeout=this.timers.setTimeout(this._setCtrlKeyTimeout,150)),e.metaKey?(clearTimeout(this._metaKeyTimeout),this._metaKeyTimeout=-1,t.metaKey=!0):!e.metaKey&&t.metaKey&&-1===this._metaKeyTimeout&&(this._metaKeyTimeout=this.timers.setTimeout(this._setMetaKeyTimeout,150));let{originPagePoint:s,currentPagePoint:r}=t;t.isPointing||(t.isDragging=!1);let n=this.store.unsafeGetWithoutCapture(eb.PQ),a=this.store.get(this._getCurrentPageStateId()),h=this._cameraOptions.__unsafe__getWithoutCapture();switch(i){case"pinch":if(h.isLocked)return;switch(clearTimeout(this._longPressTimeout),this._updateInputsFromEvent(e),e.name){case"pinch_start":if(t.isPinching)return;t.isEditing||(this._pinchStart=this.getCamera().z,this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=[...a.selectedShapeIds]),this._didPinch=!0,t.isPinching=!0,this.interrupt());return;case"pinch":{if(!t.isPinching)return;let{point:{z:i=1},delta:{x:s,y:r}}=e,{x:a,y:o}=eZ.B.SubXY(e.point,n.screenBounds.x,n.screenBounds.y);this.stopCameraAnimation(),n.followingUserId&&this.stopFollowingUser();let{x:l,y:p,z:g}=(0,eB.dy)(()=>this.getCamera()),{panSpeed:d}=h;this._setCamera(new eZ.B(l+s*d/g-a/g+a/i,p+r*d/g-o/g+o/i,i),{immediate:!0});return}case"pinch_end":{if(!t.isPinching)return this;t.isPinching=!1;let{_selectedShapeIdsAtPointerDown:e}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,e.length>0&&this.once("tick",()=>{this._didPinch||this.setSelectedShapes(e)}));return}}case"wheel":{if(h.isLocked)return;this._updateInputsFromEvent(e);let{panSpeed:t,zoomSpeed:i,wheelBehavior:s}=h;if("none"!==s){this.stopCameraAnimation(),n.followingUserId&&this.stopFollowingUser();let{x:r,y:a,z:h}=(0,eB.dy)(()=>this.getCamera()),{x:o,y:l,z:p=0}=e.delta,g=s;switch(e.ctrlKey&&(g="pan"===s?"zoom":"pan"),g){case"zoom":{let{x:e,y:t}=this.inputs.currentScreenPoint,n=p;"zoom"===s&&(n=Math.abs(l)>10?10*Math.sign(l)/100:l/100);let o=h+(n??0)*i*h;this._setCamera(new eZ.B(r+e/o-e/h,a+t/o-t/h,o),{immediate:!0}),this.maybeTrackPerformance("Zooming");return}case"pan":this._setCamera(new eZ.B(r+o*t/h,a+l*t/h,h),{immediate:!0}),this.maybeTrackPerformance("Panning");return}}break}case"pointer":{if(t.isPinching)return;this._updateInputsFromEvent(e);let{isPen:i}=e,{isPenMode:a}=n;switch(e.name){case"pointer_down":if(a&&!i)return;if(this.inputs.isPanning||(this._longPressTimeout=this.timers.setTimeout(()=>{let t=this.getViewportScreenBounds();this.dispatch({...e,point:this.inputs.originScreenPoint.clone().addXY(t.x,t.y),name:"long_press"})},this.options.longPressDurationMs)),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),e.button===eE.QN&&(this.capturedPointerId=e.pointerId),t.buttons.add(e.button),t.isPointing=!0,t.isDragging=!1,!a&&i&&this.updateInstanceState({isPenMode:!0}),e.button===eE.an?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):e.button===eE.sz&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0,clearTimeout(this._longPressTimeout)),this.inputs.isPanning)return this.stopCameraAnimation(),this.setCursor({type:"grabbing",rotation:0}),this;break;case"pointer_move":{if(!i&&a)return;let{x:e,y:h,z:o}=(0,eB.dy)(()=>this.getCamera());if(this.inputs.isPanning&&this.inputs.isPointing){let{currentScreenPoint:t,previousScreenPoint:i}=this.inputs,s=eZ.B.Sub(t,i);this.setCamera(new eZ.B(e+s.x/o,h+s.y/o,o),{immediate:!0}),this.maybeTrackPerformance("Panning");return}t.isPointing&&!t.isDragging&&eZ.B.Dist2(s,r)*this.getZoomLevel()>(n.isCoarsePointer?this.options.coarseDragDistanceSquared:this.options.dragDistanceSquared)/o&&(t.isDragging=!0,clearTimeout(this._longPressTimeout));break}case"pointer_up":if(t.isDragging=!1,t.isPointing=!1,clearTimeout(this._longPressTimeout),t.buttons.delete(e.button),n.isPenMode&&!i)return;if(this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),t.isPanning){t.keys.has("Space")||(t.isPanning=!1,t.isSpacebarPanning=!1);let i=this.inputs.pointerVelocity,s=Math.min(2,i.len());switch(e.button){case eE.QN:this.setCursor({type:"grab",rotation:0});break;case eE.sz:this.inputs.keys.has(" ")?this.setCursor({type:"grab",rotation:0}):this.setCursor({type:this._prevCursor,rotation:0})}s>0&&this.slideCamera({speed:s,direction:i})}else e.button===eE.an&&(this.complete(),this.setCurrentTool(this._restoreToolId))}break}case"keyboard":switch("ShiftRight"===e.key&&(e.key="ShiftLeft"),"AltRight"===e.key&&(e.key="AltLeft"),"ControlRight"===e.code&&(e.code="ControlLeft"),"MetaRight"===e.code&&(e.code="MetaLeft"),e.name){case"key_down":if(t.keys.add(e.code),"Space"!==e.code||e.ctrlKey||(this.inputs.isPanning||(this._prevCursor=n.cursor.type),this.inputs.isPanning=!0,this.inputs.isSpacebarPanning=!0,clearTimeout(this._longPressTimeout),this.setCursor({type:this.inputs.isPointing?"grabbing":"grab",rotation:0})),this.inputs.isSpacebarPanning){let t;switch(e.code){case"ArrowUp":t=new eZ.B(0,-1);break;case"ArrowRight":t=new eZ.B(1,0);break;case"ArrowDown":t=new eZ.B(0,1);break;case"ArrowLeft":t=new eZ.B(-1,0)}if(t){let e=this.getViewportPageBounds(),i=e.clone().translate(t.mulV({x:e.w,y:e.h}));this._animateToViewport(i,{animation:{duration:320}})}}break;case"key_up":t.keys.delete(e.code),"Space"===e.code&&(this.inputs.buttons.has(eE.sz)||(this.inputs.isPanning=!1,this.inputs.isSpacebarPanning=!1,this.setCursor({type:this._prevCursor,rotation:0})))}}if("pointer"===e.type){e.button===eE.sz?e.name="middle_click":e.button===eE.Hs&&(e.name="right_click");let{isPenMode:t}=this.store.unsafeGetWithoutCapture(eb.PQ);if(e.isPen===t){let t=this._clickManager.handlePointerEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}}}return this.root.handleEvent(e),this.emit("event",e),"pointer"===e.type&&"pointer_down"===e.name&&this.menus.clearOpenMenus(),this}maybeTrackPerformance(e){eW.hR.measurePerformance.get()&&(this.performanceTracker.isStarted()?clearTimeout(this.performanceTrackerTimeout):this.performanceTracker.start(e),this.performanceTrackerTimeout=this.timers.setTimeout(()=>{this.performanceTracker.stop()},50))}}function tv(e,t=e.getCurrentPageId()){let i=e.getPage(t).name;e.emit("max-shapes",{name:i,pageId:t,count:e.options.maxShapesPerPage})}function tk(e,t){if(!t)return e;let i=null,s=Object.entries(t);for(let t=0,r=s.length;t<r;t++){let[r,n]=s[t];if(void 0!==n&&"id"!==r&&"type"!==r&&"typeName"!==r&&n!==e[r]){if(i||(i={...e}),"props"===r||"meta"===r){for(let[t,s]of(i[r]={...e[r]},Object.entries(n)))i[r][t]=s;continue}i[r]=n}}return i||e}function tF(e,t,i){let s;if(e.run(()=>{let r=e.store.extractingChanges(()=>{let r=new Set,n=new Set;for(let i of t)if(e.getShape(i))for(let s of e.getBindingsInvolvingShape(i)){let e=t.has(s.fromId),i=t.has(s.toId);if(e&&i){r.add(s.id);continue}e&&i||n.add(s.id)}e.deleteBindings([...n],{isolateShapes:!0});try{s=ev.x4.ok(i(r))}catch(e){s=ev.x4.err(e)}});e.store.applyDiff((0,eT.kJ)(r),{runCallbacks:!1})},{history:"ignore"}),s.ok)return s.value;throw s.error}function tA(e,t){if(!t.constraints)throw Error("Should have constraints here");let{padding:{x:i,y:s}}=t.constraints,r=e.getViewportScreenBounds(),n=eD.xu.From(t.constraints.bounds);return{zx:(r.w-2*i)/n.w,zy:(r.h-2*s)/n.h}}tP(ex=[,,,to(e_?.[tg("metadata")]??null)],1,"getIsShapeHiddenCache",ew,tb),tP(ex,1,"getCanUndo",eC,tb),tP(ex,1,"getCanRedo",eP,tb),tP(ex,1,"getPath",eI,tb),tP(ex,1,"getCurrentTool",ey,tb),tP(ex,1,"getCurrentToolId",em,tb),tP(ex,1,"getDocumentSettings",ef,tb),tP(ex,1,"getInstanceState",eS,tb),tP(ex,1,"getOpenMenus",ec,tb),tP(ex,1,"getIsMenuOpen",eu,tb),tP(ex,1,"getPageStates",ed,tb),tP(ex,1,"_getPageStatesQuery",eg,tb),tP(ex,1,"getCurrentPageState",ep,tb),tP(ex,1,"_getCurrentPageStateId",el,tb),tP(ex,1,"getSelectedShapeIds",eo,tb),tP(ex,1,"getSelectedShapes",eh,tb),tP(ex,1,"getCurrentPageShapesInReadingOrder",ea,tb),tP(ex,1,"getOnlySelectedShapeId",en,tb),tP(ex,1,"getOnlySelectedShape",er,tb),tP(ex,1,"getSelectionPageBounds",es,tb),tP(ex,1,"getSelectionRotation",ei,tb),tP(ex,1,"getSelectionRotatedPageBounds",et,tb),tP(ex,1,"getSelectionRotatedScreenBounds",ee,tb),tP(ex,1,"getFocusedGroupId",J,tb),tP(ex,1,"getFocusedGroup",$,tb),tP(ex,1,"getEditingShapeId",W,tb),tP(ex,1,"getEditingShape",Q,tb),tP(ex,1,"getRichTextEditor",j,tb),tP(ex,1,"getHoveredShapeId",q,tb),tP(ex,1,"getHoveredShape",X,tb),tP(ex,1,"getHintingShapeIds",Y,tb),tP(ex,1,"getHintingShape",N,tb),tP(ex,1,"getErasingShapeIds",G,tb),tP(ex,1,"getErasingShapes",Z,tb),tP(ex,1,"_unsafe_getCameraId",H,tb),tP(ex,1,"getCamera",D,tb),tP(ex,1,"getViewportPageBoundsForFollowing",V,tb),tP(ex,1,"getCameraForFollowing",z,tb),tP(ex,1,"getZoomLevel",K,tb),tP(ex,1,"getViewportScreenBounds",L,tb),tP(ex,1,"getViewportScreenCenter",R,tb),tP(ex,1,"getViewportPageBounds",U,tb),tP(ex,1,"_getCollaboratorsQuery",E,tb),tP(ex,1,"getCollaborators",O,tb),tP(ex,1,"getCollaboratorsOnCurrentPage",M,tb),tP(ex,1,"getRenderingShapes",A,tb),tP(ex,1,"_getAllPagesQuery",F,tb),tP(ex,1,"getPages",k,tb),tP(ex,1,"getCurrentPageId",v,tb),tP(ex,1,"getCurrentPageShapeIdsSorted",b,tb),tP(ex,1,"_getAllAssetsQuery",T,tb),tP(ex,1,"_getShapeHandlesCache",B,tb),tP(ex,1,"_getShapePageTransformCache",_,tb),tP(ex,1,"_getShapePageBoundsCache",w,tb),tP(ex,1,"_getShapeClipPathCache",C,tb),tP(ex,1,"_getShapeMaskCache",P,tb),tP(ex,1,"_getShapeMaskedPageBoundsCache",I,tb),tP(ex,1,"getNotVisibleShapes",y,tb),tP(ex,1,"getCulledShapes",m,tb),tP(ex,1,"getCurrentPageBounds",f,tb),tP(ex,1,"getCurrentPageShapes",S,tb),tP(ex,1,"getCurrentPageShapesSorted",c,tb),tP(ex,1,"getCurrentPageRenderingShapesSorted",u,tb),tP(ex,1,"_getBindingsIndexCache",d,tb),tP(ex,1,"_getSelectionSharedStyles",g,tb),tP(ex,1,"getSharedStyles",p,tb),tP(ex,1,"getSharedOpacity",l,tb),tP(ex,1,"getIsFocused",o,tb),tP(ex,1,"getIsReadonly",h,tb),tP(ex,1,"_setShiftKeyTimeout",a,tb),tP(ex,1,"_setAltKeyTimeout",n,tb),tP(ex,1,"_setCtrlKeyTimeout",r,tb),tP(ex,1,"_setMetaKeyTimeout",s,tb),ty(ex,tb)}}]);